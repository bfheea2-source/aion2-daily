<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AION2 ì¼ì¼ìˆ™ì œ</title>
  <style>
    :root{
      --border:#111;
      --grid:#222;
      --bg:#fff;
      --soft:#f3f5f8;
      --rowA:#eaf0ff;
      --rowB:#ffffff;
      --weekend:#f7caa8;
      --tab:#f2f2f2;
      --tabActive:#fff;
      --muted:#666;
      --shadow:0 2px 10px rgba(0,0,0,0.06);
    }

    *{box-sizing:border-box;}
    body{
      margin:0;
      padding:18px;
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans KR",Arial,sans-serif;
      background:var(--soft);
      color:#111;
    }
    .wrap{max-width:1200px;margin:0 auto;}
    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    h1{margin:0;font-size:20px;letter-spacing:-0.2px;}
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.3;
      text-align:right;
    }

    .card{
      background:var(--bg);
      border:1px solid #ddd;
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
      flex: 1 1 auto;
      min-width: 0;
    }

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      padding:10px;
      border-bottom:1px solid #e7e7e7;
      background:#fafafa;
      align-items:center;
    }
    .tab{
      border:1px solid #ddd;
      background:var(--tab);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:13px;
      user-select:none;
    }

    .tab.dragging{
      opacity:0.4;
    }
    .tab.active{
      background:var(--tabActive);
      border-color:#bbb;
      font-weight:700;
    }
    .tabs .spacer{flex:1;}

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-bottom:1px solid #e7e7e7;
      background:#fff;
    }
    .leftTools,.rightTools{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    button{
      border:1px solid #ddd;
      background:#fff;
      padding:7px 10px;
      border-radius:10px;
      cursor:pointer;
      font-size:12px;
    }
    button:hover{border-color:#bbb;}
    button:disabled{
      cursor:not-allowed;
      opacity:0.55;
    }
    .danger{
      border-color:#f0b4b4;
      background:#fff7f7;
    }
    .small{font-size:12px;color:var(--muted);}

    .gridWrap{
      padding:10px;
      overflow-x:hidden;
    }

    table{
      border-collapse:collapse;
      width:100%;
      min-width:0;
      table-layout:fixed;
      border:2px solid var(--border);
      background:#fff;
    }

    th,td{
      border:1px solid var(--grid);
      text-align:center;
      padding:6px 4px;
      font-size:12px;
      vertical-align:middle;
      overflow:hidden;
    }

    thead th{font-weight:800;background:#f6f6f6;}
    thead th.weekend{background:var(--weekend);}

    th.taskCol{
      width:170px;
      background:#ffe0cf;
      border-right:2px solid var(--border);
    }

    tbody tr:nth-child(odd) td{background:var(--rowA);}
    tbody tr:nth-child(even) td{background:var(--rowB);}

    td.taskName{
      font-weight:800;
      border-right:2px solid var(--border);
      background:#fff;
      text-align:center;
      white-space:nowrap;
    }

    .dayHead{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      justify-content:center;
    }
    .dayBtns{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
    }
    .dayBtns button{
      padding:4px 6px;
      font-size:11px;
      border-radius:9px;
      width:84px;
      white-space:nowrap;
    }

    input[type="checkbox"]{
      width:16px;
      height:16px;
      cursor:pointer;
      accent-color:#111;
    }

    .status{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:12px;
      color:#222;
      padding:2px 6px;
      border:1px solid #e2e2e2;
      border-radius:8px;
      background:#fafafa;
    }
    .pill{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #e2e2e2;
      background:#fafafa;
      font-size:12px;
    }
    .pill strong{font-weight:900;}

    .badgeWeekly{
      margin-left:8px;
      font-size:11px;
      color:#444;
      border:1px solid #ddd;
      background:#fafafa;
      padding:2px 6px;
      border-radius:999px;
    }

    .hoerangBox{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      justify-content:center;
      padding-left:0;
    }
    .mini{
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      user-select:none;
      white-space:nowrap;
    }
    .mini input[type="checkbox"]{
      width:14px;
      height:14px;
    }

    /* ì •ë³µ/ì¹´ìš´í„° UI */
    .conqBox{
      display:flex;
      flex-direction:column;
      gap:4px;
      align-items:center;
      justify-content:center;
    }
    .conqCtr{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      white-space:nowrap;
    }
    .conqCtr button{
      padding:2px 8px;
      font-size:12px;
      border-radius:8px;
    }
    .conqInfo{
      font-size:11px;
      color:#444;
      line-height:1.2;
    }

    footer{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .mainLayout{
      display:flex;
      gap:16px;
      align-items:flex-start;
    }

    .btn2x{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      height:22px;
      padding:0 10px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#f6f7fb;
      font-size:12px;
      font-weight:900;
      color:#333;
      cursor:pointer;
    }

    .btn2x:hover{
      background:#eef0ff;
      border-color:#bbb;
    }

    .btn2x:disabled{
      opacity:0.45;
      cursor:not-allowed;
    }

    /* ===== ìˆ˜ì •íƒ­(ëª¨ë‹¬) ì…ë ¥ 3ì¹¸ UI ===== */
    .field3{
      flex:1 1 auto;
      display:grid;
      grid-template-columns: repeat(3, minmax(110px, 1fr));
      gap:10px;
      align-items:end;
      min-width:0;
    }

    .field3 .col{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .field3 .col span{
      font-size:11px;
      color:#444;
      font-weight:900;
      letter-spacing:-0.2px;
      white-space:nowrap;
    }

    .field3 input:disabled{
      background:#f5f6f8;
      color:#333;
      opacity:1;
    }

    @media (max-width: 640px){
      .modal{ width:min(560px, 96vw); }
      .field3{ grid-template-columns: repeat(2, minmax(110px, 1fr)); }
    }
    @media (max-width: 480px){
      .field3{ grid-template-columns: 1fr; }
      .formRow > label{ flex:0 0 90px; }
    }

    .sidePanel{
      width:280px;
      background:#fff;
      border:1px solid #ddd;
      border-radius:14px;
      padding:12px;
      box-shadow:0 2px 10px rgba(0,0,0,0.06);
      position:sticky;
      top:16px;
      white-space:nowrap;
      word-break:keep-all;
    }
    
    button.cloud {
      background:#eef4ff;
      border-color:#8fb3ff;
    }
    
    .toolSep {
      width:1px;
      height:26px;
      background:#ddd;
      display:inline-block;
      margin:0 6px;
    }

    .toastHost{
      position:fixed;
      right:16px;
      bottom:16px;
      display:flex;
      flex-direction:column;
      gap:8px;
      z-index:100000;
      pointer-events:none;
    }

    .toast{
      pointer-events:auto;
      min-width:260px;
      max-width:min(420px, 92vw);
      background:#111;
      color:#fff;
      border:1px solid rgba(255,255,255,0.18);
      border-radius:14px;
      box-shadow:0 10px 26px rgba(0,0,0,0.22);
      padding:10px 12px;
      opacity:0;
      transform:translateY(8px);
      transition:opacity 180ms ease, transform 180ms ease;
    }

    .toast.show{
      opacity:1;
      transform:translateY(0);
    }

    .toast .tTitle{
      font-weight:900;
      font-size:13px;
      letter-spacing:-0.2px;
      margin-bottom:4px;
    }

    .toast .tBody{
      font-size:12px;
      opacity:0.92;
      line-height:1.35;
    }

    .toast .tHint{
      margin-top:6px;
      font-size:11px;
      opacity:0.75;
    }

    button,
    .tab,
    input[type="checkbox"],
    label,
    .badgeWeekly,
    .btn2x {
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      caret-color: transparent;
    }
    
    .sidePanel h3{
      margin:0;
      font-size:14px;
      font-weight:900;
      padding:0;
      border-bottom:none;
    }

    .sideEditBtn{
      width:24px;
      height:24px;
      padding:0;
      border-radius:8px;
      font-weight:900;
      line-height:1;
      background:#f6f7fb;
    }

    .sideEditBtn:hover{
      background:#eef0ff;
      border-color:#bbb;
    }

    .sideValueWrap{
      display:inline-flex;
      align-items:center;
      justify-content:flex-end;
      gap:6px;
    }

    .sidePlusBtn{
      width:24px;
      height:24px;
      padding:0;
      border-radius:8px;
      font-weight:900;
      line-height:1;
    }

    .sideItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      margin-bottom:10px;
      padding:8px 10px;
      border:1px solid #eee;
      border-radius:10px;
      background:#fafafa;
      white-space:nowrap;
      word-break:keep-all;
    }

    .sideItem strong{
      flex:0 0 78px;
      font-weight:800;
      color:#333;
    }

    .sideItem span{
      flex:1 1 auto;
      text-align:right;
      font-variant-numeric: tabular-nums;
    }

    .sideSection{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed #e6e6e6;
      font-size:12px;
      color:#444;
      font-weight:900;
      letter-spacing:-0.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .sideSection .tag{
      font-weight:900;
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #ddd;
      background:#fafafa;
      color:#333;
    }

    .sideGap{
      height:12px;
    }

    .sideHead{
      display:flex;
      flex-wrap:nowrap;
      align-items:center;
      justify-content:flex-start;
      gap:8px;
      margin-bottom:10px;
      padding-bottom:8px;
      border-bottom:1px solid #eee;
    }

    .sideHead h3{
      margin:0;
      padding:0;
      border:0;
      flex:0 0 auto;
    }

    .editBtn{
      flex:0 0 auto;
      padding:4px 10px;
      height:24px;
      line-height:1;
      border-radius:999px;
    }

    /* ìºë¦­í„° ì¢Œ/ìš° ì´ë™ ë²„íŠ¼ */
    #prevCharBtn,
    #nextCharBtn{
      width:36px;
      padding:0;
      text-align:center;
      font-weight:900;
    }

    .editBtn:hover{
      border-color:#bbb;
      background:#fafafa;
    }

    /* ===== ëª¨ë‹¬ ===== */
    .modalOverlay{
      position:fixed;
      left:0; top:0; right:0; bottom:0;
      background:rgba(0,0,0,0.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:9999;
    }

    .modal{
      width:min(720px, 96vw);
      background:#fff;
      border:1px solid #ddd;
      border-radius:14px;
      box-shadow:0 12px 30px rgba(0,0,0,0.18);
      overflow:hidden;
    }

    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid #eee;
      background:#fafafa;
    }

    .modalHeader strong{
      font-size:14px;
    }

    .modalBody{
      padding:14px;
      display:flex;
      flex-direction:column;
      gap:10px;
      max-height:70vh;
      overflow:auto;
    }

    .formRow{
      display:flex;
      justify-content:flex-start;
      align-items:flex-start;
      gap:14px;
    }

    .formRow label{
      flex:0 0 110px;
      white-space:nowrap;
      word-break:keep-all;
      padding-top:8px;
      font-size:13px;
      font-weight:800;
      color:#222;
    }

    .formRow input{
      height:32px;
      padding:6px 10px;
      border-radius:10px;
      font-size:12px;
      border:1px solid #ddd;
    }

    .modalFooter{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      padding:12px 14px;
      border-top:1px solid #eee;
      background:#fafafa;
    }

    .btnPrimary{
      border-color:#bbb;
      background:#111;
      color:#fff;
      font-weight:900;
    }

    .btnPrimary:hover{
      opacity:0.9;
    }

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    
      const firebaseConfig = {
        apiKey: "AIzaSyChkORuRT7JNcN3UtYOYAydCXLzZyehYvI",
        authDomain: "aion2-61196.firebaseapp.com",
        projectId: "aion2-61196",
        storageBucket: "aion2-61196.firebasestorage.app",
        messagingSenderId: "842564133938",
        appId: "1:842564133938:web:93133616ef96942f56882b"
      };
    
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
    
      // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (ê¸°ì¡´ ì½”ë“œì™€ ì„ê¸° ìœ„í•¨)
      window.__fb = {
        auth, db,
        GoogleAuthProvider,
        signInWithPopup,
        onAuthStateChanged,
        signOut,
        doc, getDoc, setDoc, serverTimestamp
      };
    </script>

    .note{font-size:12px;color:var(--muted);}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ì•„ì´ì˜¨2 ìˆ™ì œ</h1>
        <div class="note"></div>
      </div>
      <div class="hint">
        ì²´í¬í•˜ë©´ ì¦‰ì‹œ ì €ì¥ë©ë‹ˆë‹¤ (localStorage).<br/>
        ë‹¤ë¥¸ PC/ë¸Œë¼ìš°ì €ë¡œëŠ” ìë™ ë™ê¸°í™”ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
      </div>
    </header>

    <div class="mainLayout">
      <div class="card">
        <div id="tabs" class="tabs"></div>

        <div class="toolbar">
          <div class="leftTools">
            <span class="small">í˜„ì¬ ìºë¦­í„°:</span>
            <span id="currentCharLabel" class="status">-</span>

            <span class="small">ì˜¤ëŠ˜:</span>
            <span id="todayLabel" class="pill">-</span>

            <button id="toggleViewBtn" type="button">ì „ì²´ ë³´ê¸°</button>

            <span class="small">ë§ˆì§€ë§‰ ì €ì¥:</span>
            <span id="lastSavedLabel" class="status">-</span>
          </div>

          <div class="rightTools">
            <button id="addCharBtn" type="button">ìºë¦­í„° ì¶”ê°€</button>
            <button id="renameCharBtn" type="button">ì´ë¦„ ìˆ˜ì •(ë¦¬ë„¤ì„)</button>
            <button id="removeCharBtn" type="button" class="danger">í˜„ì¬ ìºë¦­í„° ì‚­ì œ</button>
          
            <button id="resetCharBtn" type="button">ì´ ìºë¦­í„° ì „ì²´ ì´ˆê¸°í™”</button>
            <button id="resetAllBtn" type="button">ëª¨ë“  ìºë¦­í„° ì „ì²´ ì´ˆê¸°í™”</button>
          
            <button id="exportBtn" type="button">ë°±ì—… ë‚´ë³´ë‚´ê¸°(JSON)</button>
            <button id="importBtn" type="button">ë³µì› ê°€ì ¸ì˜¤ê¸°(JSON)</button>
          
            <!-- ğŸ”½ Firebase ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ -->
            <span class="toolSep"></span>
          
            <button id="loginBtn" type="button" class="cloud">Google ë¡œê·¸ì¸</button>
            <button id="logoutBtn" type="button" class="cloud" style="display:none;">ë¡œê·¸ì•„ì›ƒ</button>
          </div>
          
        </div>

        <div class="gridWrap">
          <table id="gridTable" aria-label="ì¼ì¼ ìˆ™ì œ ì²´í¬í‘œ"></table>
        </div>
      </div>

      <div class="sidePanel">
        <div class="sideHead">
          <h3>ìºë¦­í„° ì •ë³´</h3>

          <button id="prevCharBtn" type="button" class="editBtn" title="ì´ì „ ìºë¦­í„°">â—€</button>
          <button id="editCharBtn" type="button" class="editBtn">ìˆ˜ì •</button>
          <button id="nextCharBtn" type="button" class="editBtn" title="ë‹¤ìŒ ìºë¦­í„°">â–¶</button>
        </div>

        <div class="sideItem">
          <strong>ì´ë¦„</strong>
          <span id="sideCharName">-</span>
        </div>

        <div class="sideItem">
          <strong>ì•„ì´í…œë ˆë²¨</strong>
          <span id="sideItemLevel">0</span>
        </div>

        <div class="sideItem">
          <strong>ì´ ì˜¤ë“œì—ë„ˆì§€</strong>
          <span class="sideValueWrap">
            <span id="sideOddTotal">0</span>
            <button id="sideOddAddBtn" type="button" class="sideEditBtn" title="ì¶”ê°€ ì˜¤ë“œì—ë„ˆì§€ ìˆ˜ì •">âœ</button>
          </span>
        </div>

        
        <div class="sideItem">
          <strong>ë‹¤ìŒ ì˜¤ë“œ</strong>
          <span id="sideOddNext">-</span>
        </div>

        <div class="sideItem">
          <strong>ì¶©ì „ ì‹œê°„ ë³´ì •</strong>
          <span>
            <button id="oddCalibResetBtn" type="button" class="danger" style="padding:4px 10px;border-radius:999px;">
              ë³´ì •ì´ˆê¸°í™”
            </button>
          </span>
        </div>

        <div class="sideGap"></div>

        <div class="sideSection">
          <span>ë³´ìƒê°€ëŠ¥</span>
          <span class="tag">ì˜¤ë“œ 40 ê¸°ì¤€</span>
        </div>

        <div class="sideItem">
          <strong>ì •ë³µ</strong>
          <span id="sideConquest">0 íšŒ</span>
        </div>

        <div class="sideItem">
          <strong>ì´ˆì›”</strong>
          <span id="sideTranscend">0 íšŒ</span>
        </div>

        <div class="sideGap"></div>

        <div class="sideSection">
          <span>ë„ì „ê°€ëŠ¥</span>
          <span class="tag">ì”ì—¬ íšŸìˆ˜</span>
        </div>

        <div class="sideItem">
          <strong>ì•…ëª½</strong>
          <span class="sideValueWrap">
            <span id="sideNightmareAvail">0 íšŒ</span>
            <button id="sideNmAddBtn" type="button" class="sideEditBtn" title="ì•…ëª½ ì¶”ê°€ ì…ì¥ê¶Œ ìˆ˜ì •">âœ</button>
          </span>
        </div>

        <div class="sideItem">
          <strong>ì¼ì¼ë˜ì „</strong>
          <span class="sideValueWrap">
            <span id="sideDailyDungeonAvail">0 íšŒ</span>
            <button id="sideDdAddBtn" type="button" class="sideEditBtn" title="ì¼ì¼ë˜ì „ ì¶”ê°€ ì…ì¥ê¶Œ ìˆ˜ì •">âœ</button>
          </span>
        </div>

        <div class="sideItem">
          <strong>ê°ì„±ì „</strong>
          <span class="sideValueWrap">
            <span id="sideAwakeningAvail">0 íšŒ</span>
            <button id="sideAwAddBtn" type="button" class="sideEditBtn" title="ê°ì„±ì „ ì¶”ê°€ ì…ì¥ê¶Œ ìˆ˜ì •">âœ</button>
          </span>
        </div>

        <div class="sideItem">
          <strong>í† ë²Œì „</strong>
          <span class="sideValueWrap">
            <span id="sideRaidAvail">0 íšŒ</span>
            <button id="sideRdAddBtn" type="button" class="sideEditBtn" title="í† ë²Œì „ ì¶”ê°€ ì…ì¥ê¶Œ ìˆ˜ì •">âœ</button>
          </span>
        </div>

        <div class="sideGap"></div>

        <div class="sideSection">
          <span>ì´ë²¤íŠ¸</span>
          <span class="tag">ìŠˆê³ í˜ìŠ¤íƒ€</span>
        </div>

        <div class="sideItem">
          <strong>ìŠˆê³ í˜ìŠ¤íƒ€</strong>
          <span id="sideShugoRemain">-</span>
        </div>

        <div class="sideItem">
          <strong>ë‹¤ìŒ ì‹œê°„</strong>
          <span id="sideShugoNext">-</span>
        </div>

        <div class="sideItem">
          <strong>ì•ŒëŒ</strong>
          <span>
            <button id="shugoAlarmBtn" type="button" class="editBtn" style="padding:4px 10px;border-radius:999px;">
              ì•ŒëŒ í—ˆìš©
            </button>
          </span>
        </div>
      </div>
    </div>


    <footer>
      - â€œì˜¤ëŠ˜ë§Œ ë³´ê¸°â€ëŠ” ì˜¤ëŠ˜ ìš”ì¼ ì—´ë§Œ í‘œì‹œí•©ë‹ˆë‹¤. ë²„íŠ¼ìœ¼ë¡œ â€œì „ì²´ ë³´ê¸°(ì›”~ì¼)â€ë¡œ ì „í™˜ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br/>
      - ìš”ì¼ë³„ â€œì „ì²´ì²´í¬/ì „ì²´í•´ì œâ€ëŠ” í•´ë‹¹ ìš”ì¼ ì—´ë§Œ ì ìš©ë©ë‹ˆë‹¤.<br/>
      - <b>ê°ì„±ì „/í† ë²Œì „</b>ì€ ì£¼ 1íšŒ: ì–´ë–¤ ìš”ì¼ì„ ì²´í¬í•´ë„ <b>ì „ ìš”ì¼ì— ë™ì‹œì— ë°˜ì˜</b>ë©ë‹ˆë‹¤.<br/>
      - <b>íšŒë‘</b>ì€ ìš”ì¼ ì¹¸ ì•ˆì— <b>ë¿Œë¦¬/ë‚ ê°œ/ìœ í™©</b> 3ê°œ ì²´í¬ë¡œ ê´€ë¦¬ë©ë‹ˆë‹¤.<br/>
      - <b>ì •ë³µ</b>ì€ ì²´í¬ë°•ìŠ¤ ëŒ€ì‹  <b>+/- ì¹´ìš´í„°</b> (1íšŒ = ì˜¤ë“œì—ë„ˆì§€ 40, ì¼ë°˜â†’ì¶©ì „ ì°¨ê° / -ëŠ” ì •í™• í™˜ê¸‰).<br/>
      - <b>ì¼ì¼ë˜ì „</b> ê¸°ë³¸ ì…ì¥ê¶Œ: <b>ë§¤ì£¼ ìˆ˜ìš”ì¼ ìƒˆë²½ 5ì‹œ</b>ì— <b>7ì¥ìœ¼ë¡œ ë¦¬í•„</b> (ìµœëŒ€ 7), ì¶”ê°€ ì…ì¥ê¶Œì€ ë¬´ì œí•œ.
    </footer>

    <!-- ===== ëª¨ë‹¬ ===== -->
    <div id="editModal" class="modalOverlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-label="ìºë¦­í„° ì •ë³´ ìˆ˜ì •">
        <div class="modalHeader">
          <strong>ìºë¦­í„° ì •ë³´ ìˆ˜ì •</strong>
          <button id="editModalCloseX" type="button">ë‹«ê¸°</button>
        </div>

        <div class="modalBody">
          <div class="formRow">
            <label>ìºë¦­í„° ì´ë¦„</label>
            <input id="editName" type="text" />
          </div>

          <div class="formRow">
            <label>ì•„ì´í…œë ˆë²¨</label>
            <input id="editItemLevel" type="number" min="0" />
          </div>

          <div class="formRow">
            <label>ì˜¤ë“œì—ë„ˆì§€</label>
            <div class="field3">
              <div class="col">
                <span>ê¸°ë³¸ ì˜¤ë“œì—ë„ˆì§€</span>
                <input id="editOddNormal" type="number" min="0" />
              </div>
              <div class="col">
                <span>ì¶”ê°€ ì˜¤ë“œì—ë„ˆì§€</span>
                <input id="editOddCharged" type="number" min="0" />
              </div>
              <div class="col">
                <span>ì´ ì˜¤ë“œì—ë„ˆì§€</span>
                <input id="editOddTotal" type="number" disabled />
              </div>
            </div>
          </div>

          <div class="formRow">
            <label>ì•…ëª½</label>
            <div class="field3">
              <div class="col">
                <span>ê¸°ë³¸ ì…ì¥ê¶Œ</span>
                <input id="editNightmareBase" type="number" min="0" />
              </div>
              <div class="col">
                <span>ì¶”ê°€ ì…ì¥ê¶Œ</span>
                <input id="editNightmareBonus" type="number" min="0" />
              </div>
              <div class="col">
                <span>ì´ ì…ì¥ê¶Œ</span>
                <input id="editNightmareTotal" type="number" disabled />
              </div>
            </div>
          </div>

          <div class="formRow">
            <label>ì¼ì¼ë˜ì „</label>
            <div class="field3">
              <div class="col">
                <span>ê¸°ë³¸ ì…ì¥ê¶Œ</span>
                <input id="editDailyDungeonBase" type="number" min="0" max="7" />
              </div>
              <div class="col">
                <span>ì¶”ê°€ ì…ì¥ê¶Œ</span>
                <input id="editDailyDungeonBonus" type="number" min="0" />
              </div>
              <div class="col">
                <span>ì´ ì…ì¥ê¶Œ</span>
                <input id="editDailyDungeonTotal" type="number" disabled />
              </div>
            </div>
          </div>

          <div class="formRow">
            <label>ê°ì„±ì „</label>
            <div class="field3">
              <div class="col">
                <span>ê¸°ë³¸ ì…ì¥ê¶Œ</span>
                <input id="editAwakeningBase" type="number" min="0" />
              </div>
              <div class="col">
                <span>ì¶”ê°€ ì…ì¥ê¶Œ</span>
                <input id="editAwakeningBonus" type="number" min="0" />
              </div>
              <div class="col">
                <span>ì´ ì…ì¥ê¶Œ</span>
                <input id="editAwakeningTotal" type="number" disabled />
              </div>
            </div>
          </div>

          <div class="formRow">
            <label>í† ë²Œì „</label>
            <div class="field3">
              <div class="col">
                <span>ê¸°ë³¸ ì…ì¥ê¶Œ</span>
                <input id="editRaidBase" type="number" min="0" />
              </div>
              <div class="col">
                <span>ì¶”ê°€ ì…ì¥ê¶Œ</span>
                <input id="editRaidBonus" type="number" min="0" />
              </div>
              <div class="col">
                <span>ì´ ì…ì¥ê¶Œ</span>
                <input id="editRaidTotal" type="number" disabled />
              </div>
            </div>
          </div>

          <div class="note">
            â€» â€œì”ì—¬(ì‚¬ìš©ê°€ëŠ¥)â€ íšŸìˆ˜ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤. (ê¸°ë³¸/ì¶”ê°€ ë³´ìœ ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€)<br/>
            â€» ì˜¤ë“œì—ë„ˆì§€ëŠ” ì¼ë°˜/ì¶©ì „ ê°’ì„ ì§ì ‘ ìˆ˜ì •í•©ë‹ˆë‹¤.<br/>
            â€» ì¼ì¼ë˜ì „ ê¸°ë³¸ ì…ì¥ê¶Œì€ ì£¼ê°„ ë¦¬í•„(ìˆ˜ 05:00) ê¸°ì¤€ì´ë¯€ë¡œ, ì›í•˜ë©´ ìˆ˜ë™ìœ¼ë¡œë„ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.
          </div>
        </div>

        <div class="modalFooter">
          <button id="editModalCancel" type="button">ì·¨ì†Œ</button>
          <button id="editModalSave" type="button" class="btnPrimary">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      "use strict";

      var DAYS = ["ì›”","í™”","ìˆ˜","ëª©","ê¸ˆ","í† ","ì¼"];

      var HOERANG = "íšŒë‘";
      var HOERANG_PARTS = ["ë¿Œë¦¬","ë‚ ê°œ","ìœ í™©"];

      var CHO_WOL = "ì´ˆì›”";
      var CHO_WOL_PARTS = ["ë°ìš°ìŠ¤","ì•„ë¥´ì¹´ë‹ˆìŠ¤"];

      // âœ… ì¼ì¼ë˜ì „ ì¶”ê°€
      var TASKS = ["ë³´ê¸‰ì˜ë¢°","ì£¼ê°„ë³´ê¸‰ì˜ë¢°","ì‚¬ëª…","ì•…ëª½","ì¼ì¼ë˜ì „","ê°ì„±ì „","í† ë²Œì „","ì •ë³µ",CHO_WOL,HOERANG];

      var WEEKLY_TASK_MAP = {"ê°ì„±ì „": true, "í† ë²Œì „": true, "ì£¼ê°„ë³´ê¸‰ì˜ë¢°": true};

      // â˜… í‚¤ë¥¼ ì˜¬ë ¤ì„œ(ë²„ì „ì—…) ì €ì¥ êµ¬ì¡° ê¼¬ì„ ë°©ì§€
      var STORAGE_KEY = "dailyQuestManager.v6_2";

      var SHUGO_PREF_KEY = "dailyQuestManager.shugoPrefs.v1";

      var shugoPrefs = {
        enabled: false  // ì•± ë‚´ë¶€ì—ì„œ "ìŠˆê³  ì•ŒëŒ ì‚¬ìš©" ì—¬ë¶€
      };

      var FALLBACK_KEYS = [
        "dailyQuestManager.v6_1",
        "dailyQuestManager.v5_1",
        "dailyQuestManager.v5",
        "dailyQuestManager.v4_2",
        "dailyQuestManager.v4_1",
        "dailyQuestManager.v4",
        "dailyQuestManager.v3",
        "dailyQuestManager.v2",
        "dailyQuestManager.v1"
      ];

      var DEFAULT_CHARACTERS = ["ìºë¦­1","ìºë¦­2"];

      var state = {
        activeChar: "",
        characters: [],
        data: {},
        oddEnergy: {},
        conquestUsed: {},
        conquestSpendLog: {},
        transcendUsed: {},
        transcendSpendLog: {},
        viewMode: "today",
        counts: {},
        charMeta: {},
        today: "ì›”"
      };

      var SHUGO_KEY = "shugoFesta.v1";
      var shugoState = {     
        lastPreFiredIso: ""    // 3ë¶„ ì „ ì•Œë¦¼ ì¤‘ë³µ ë°©ì§€
      };

      function ensureToastHost(){
        var host = document.getElementById("toastHost");
        if (host) return host;

        host = document.createElement("div");
        host.id = "toastHost";
        host.className = "toastHost";
        document.body.appendChild(host);
        return host;
      }

      function showToast(title, body, ms){
        if (typeof ms !== "number" || ms <= 0) ms = 3500;

        var host = ensureToastHost();

        var el = document.createElement("div");
        el.className = "toast";

        var t = document.createElement("div");
        t.className = "tTitle";
        t.textContent = title || "";

        var b = document.createElement("div");
        b.className = "tBody";
        b.textContent = body || "";

        el.appendChild(t);
        el.appendChild(b);

        host.appendChild(el);

        // ì• ë‹ˆë©”ì´ì…˜ show
        setTimeout(function(){
          el.classList.add("show");
        }, 10);

        // ìë™ ì œê±°
        setTimeout(function(){
          el.classList.remove("show");
          setTimeout(function(){
            try{ el.remove(); } catch(e){}
          }, 220);
        }, ms);
      }

      function loadShugoState(){
        try{
          var raw = localStorage.getItem(SHUGO_KEY);
          if (!raw) return;
          var parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object"){
            if (typeof parsed.lastPreFiredIso === "string") shugoState.lastPreFiredIso = parsed.lastPreFiredIso;
          }
        } catch(e){}
      }


      function saveShugoState(){
        try{
          localStorage.setItem(SHUGO_KEY, JSON.stringify(shugoState));
        } catch(e){}
      }
      

      function askSetNumber(title, currentValue, hint){
        var s = prompt(
          title + "\n" +
          hint + "\n\n" +
          "í˜„ì¬ ê°’: " + currentValue + "\n" +
          "ìƒˆ ê°’ ì…ë ¥ (0 ì´ìƒ, ì·¨ì†Œ=ìœ ì§€)"
        );
        if (s === null) return null;

        s = String(s).trim();
        var n = parseInt(s, 10);
        if (isNaN(n) || n < 0){
          alert("ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”. (0 ì´ìƒ)");
          return null;
        }
        return n;
      }

      // âœ… ì¶”ê°€ ì˜¤ë“œì—ë„ˆì§€(charged) ê°’ì„ 'ì„¤ì •'
      function setBonusOdd(char, newValue){
        ensureCharStructures(char);

        state.oddEnergy[char].charged = newValue;

        if (state.oddEnergy[char].charged < 0) state.oddEnergy[char].charged = 0;

        save("ì¶”ê°€ ì˜¤ë“œì—ë„ˆì§€ ì„¤ì •=" + newValue);
        render();
      }

      // âœ… ì¶”ê°€ ì…ì¥ê¶Œ(bonus) ê°’ì„ 'ì„¤ì •'
      function setBonusTicket(char, type, newValue, label){
        ensureCharStructures(char);

        var c = state.counts[char][type];
        if (!c) return;

        c.bonus = newValue;

        if (c.bonus < 0) c.bonus = 0;

        // usedê°€ ì´ë³´ìœ (base+bonus)ë³´ë‹¤ í¬ë©´ clamp
        var total = (c.base || 0) + (c.bonus || 0);
        if (typeof c.used !== "number" || c.used < 0) c.used = 0;
        if (c.used > total) c.used = total;

        save((label || type) + " ì¶”ê°€ì…ì¥ê¶Œ ì„¤ì •=" + newValue);
        render();
      }


      function getNextShugoTime(now){
        var d = new Date(now.getTime());
        var min = d.getMinutes();

        if (min < 15){
          d.setMinutes(15, 0, 0);
          return d;
        }

        if (min < 45){
          d.setMinutes(45, 0, 0);
          return d;
        }

        d.setHours(d.getHours() + 1);
        d.setMinutes(15, 0, 0);
        return d;
      }

      function playRewardSound(){
        try{
          var ctx = new (window.AudioContext || window.webkitAudioContext)();
          var now = ctx.currentTime;

          function tone(freq, start, dur){
            var o = ctx.createOscillator();
            var g = ctx.createGain();
            o.type = "triangle";
            o.frequency.value = freq;
            g.gain.value = 0.07;
            o.connect(g);
            g.connect(ctx.destination);
            o.start(start);
            o.stop(start + dur);
          }

          tone(523, now + 0.0, 0.2);
          tone(659, now + 0.25, 0.2);
          tone(784, now + 0.5, 0.25);
          tone(1046, now + 0.8, 0.4);

          setTimeout(function(){
            ctx.close();
          }, 2000);
        } catch(e){}
      }

      function playShugoFestaSound(){
        try{
          var ctx = new (window.AudioContext || window.webkitAudioContext)();
          var now = ctx.currentTime;

          function tone(freq, start, dur, vol){
            var osc = ctx.createOscillator();
            var gain = ctx.createGain();
            osc.type = "square";
            osc.frequency.value = freq;
            gain.gain.value = vol;

            osc.connect(gain);
            gain.connect(ctx.destination);

            osc.start(start);
            osc.stop(start + dur);
          }

          // ğŸµ ì§§ê³  ì‹ ë‚˜ëŠ” ì•„ì¼€ì´ë“œ ë¦¬í”„ (ì´ ì•½ 2.2ì´ˆ)
          tone(880, now + 0.0, 0.18, 0.06);
          tone(1175, now + 0.2, 0.18, 0.06);
          tone(1568, now + 0.4, 0.25, 0.07);

          tone(1175, now + 0.8, 0.18, 0.06);
          tone(1568, now + 1.0, 0.22, 0.07);

          tone(1760, now + 1.4, 0.35, 0.08);

          setTimeout(function(){
            ctx.close();
          }, 2600);
        } catch(e){}
      }

      function notifyShugo(title, body){
        // Notification ìš°ì„ 
        if ("Notification" in window && Notification.permission === "granted"){
          try{
            new Notification(title, { body: body });
          } catch(e){}
          return true;
        }
        return false;
      }

      function requestShugoPermission(){
        // ë²„íŠ¼ í´ë¦­ì—ì„œ í˜¸ì¶œë˜ë¯€ë¡œ "ë¯¸ë¦¬ë“£ê¸°" ê°€ëŠ¥
        playShugoFestaSound();

        // ì•Œë¦¼ ë¯¸ì§€ì›ì´ë©´ ì•±ì€ "ì†Œë¦¬ ì•ŒëŒ"ë§Œ ON ìƒíƒœë¡œ ì €ì¥
        if (!("Notification" in window)){
          shugoPrefs.enabled = true;
          saveShugoPrefs();
          updateShugoAlarmBtn();
          alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼(Notification)ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\nì†Œë¦¬ ì•ŒëŒë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.");
          return;
        }

        // ì´ë¯¸ í—ˆìš©ì´ë©´: ì•± ë‚´ë¶€ ON ì €ì¥ + í…ŒìŠ¤íŠ¸ ì•Œë¦¼
        if (Notification.permission === "granted"){
          shugoPrefs.enabled = true;
          saveShugoPrefs();
          updateShugoAlarmBtn();

          try{
            new Notification("ìŠˆê³ í˜ìŠ¤íƒ€ ì•ŒëŒ í…ŒìŠ¤íŠ¸", { body: "3ë¶„ ì „ ì•Œë¦¼ ì˜ˆì‹œì…ë‹ˆë‹¤." });
          } catch(e){}
          return;
        }

        // ì•„ì§ ë¯¸ê²°ì •ì´ë©´ ìš”ì²­
        Notification.requestPermission().then(function(p){
          if (p === "granted"){
            shugoPrefs.enabled = true;
            saveShugoPrefs();
            updateShugoAlarmBtn();

            try{
              new Notification("ìŠˆê³ í˜ìŠ¤íƒ€ ì•ŒëŒ í—ˆìš© ì™„ë£Œ", { body: "3ë¶„ ì „ ì•Œë¦¼ìœ¼ë¡œ ì•Œë ¤ë“œë¦´ê²Œìš”!" });
            } catch(e){}
            return;
          }

          // ê±°ë¶€/ê¸°íƒ€
          shugoPrefs.enabled = false;
          saveShugoPrefs();
          updateShugoAlarmBtn();

          alert("ì•Œë¦¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ í—ˆìš©í•˜ë©´ ì•Œë¦¼ íŒì—…ë„ í•¨ê»˜ ëœ¹ë‹ˆë‹¤.\n(ì†Œë¦¬ ì•ŒëŒì€ ë²„íŠ¼ ëˆŒëŸ¬ ë¯¸ë¦¬ë“£ê¸°ë§Œ ê°€ëŠ¥)");
        });
      }

      function updateShugoAlarmBtn(){
        var btn = document.getElementById("shugoAlarmBtn");
        if (!btn) return;

        // ON/OFF í‘œê¸° (ì•± ë‚´ë¶€ enabled ê¸°ì¤€)
        if (shugoPrefs.enabled){
          btn.textContent = "ì•ŒëŒ ON / ë¯¸ë¦¬ë“£ê¸°";
          btn.classList.add("btnPrimary");
        } else {
          btn.textContent = "ì•ŒëŒ í—ˆìš© / ë¯¸ë¦¬ë“£ê¸°";
          btn.classList.remove("btnPrimary");
        }
      }

      function updateShugoPanel(){
        if (!shugoPrefs.enabled) return;
        var remainEl = document.getElementById("sideShugoRemain");
        var nextEl = document.getElementById("sideShugoNext");
        if (!remainEl || !nextEl) return;

        var now = new Date();
        var next = getNextShugoTime(now);
        var remain = next.getTime() - now.getTime();

        remainEl.textContent = formatRemainHMS(remain) + " ë‚¨ìŒ";
        nextEl.textContent = formatDateHM(next) + " (15/45ë¶„)";
        // âœ… 3ë¶„ ì „(180ì´ˆ) ì˜ˆê³  ì•Œë¦¼: ë‚¨ì€ì‹œê°„ì´ 180ì´ˆ êµ¬ê°„ì— ë“¤ì–´ì˜¤ë©´ 1íšŒë§Œ
        if (remain <= 180000 && remain > 178800){ // 180.0s ~ 178.8s (ì•½ 1.2ì´ˆ ìœˆë„ìš°)
          var preKey = next.toISOString();

          if (shugoState.lastPreFiredIso !== preKey){
            shugoState.lastPreFiredIso = preKey;
            saveShugoState();

            var okPre = notifyShugo("ìŠˆê³ í˜ìŠ¤íƒ€ 3ë¶„ ì „!", "3ë¶„ ë’¤ ì‹œì‘ (" + formatDateHM(next) + ")");
            
            playRewardSound();
            if (!okPre && (!("Notification" in window) || Notification.permission !== "granted")){
              showToast("ìŠˆê³ í˜ìŠ¤íƒ€ 3ë¶„ ì „!", "3ë¶„ ë’¤ ì‹œì‘ (" + formatDateHM(next) + ")", 3500);
            }
          }
        }
      }

      function formatRemainHMS(ms){
        if (ms < 0) ms = 0;
        var sec = Math.floor(ms / 1000);
        var m = Math.floor(sec / 60);
        var s = sec % 60;
        return m + "ë¶„ " + pad2(s) + "ì´ˆ";
      }

      function formatDateHM(d){
        return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
      }

      function switchCharByDelta(delta){
        var list = state.characters || [];
        if (!list.length) return;

        var idx = list.indexOf(state.activeChar);
        if (idx < 0) idx = 0;

        var nextIdx = idx + delta;

        if (nextIdx < 0) nextIdx = list.length - 1;
        if (nextIdx >= list.length) nextIdx = 0;

        setActiveChar(list[nextIdx]);
      }

      function nowIso(){ return new Date().toISOString(); }

      function getTodayKoreanDay(){
        var d = new Date();
        var n = d.getDay();
        if (n === 0) return "ì¼";
        if (n === 1) return "ì›”";
        if (n === 2) return "í™”";
        if (n === 3) return "ìˆ˜";
        if (n === 4) return "ëª©";
        if (n === 5) return "ê¸ˆ";
        return "í† ";
      }

      function isWeeklyTask(taskName){
        return WEEKLY_TASK_MAP[taskName] ? true : false;
      }

      function buildDefaultCharData(){
        var d = {};
        var t, day;
        for (t = 0; t < TASKS.length; t += 1){
          if (TASKS[t] === HOERANG){
            d[HOERANG] = {};
            for (day = 0; day < DAYS.length; day += 1){
              d[HOERANG][DAYS[day]] = { "ë¿Œë¦¬": false, "ë‚ ê°œ": false, "ìœ í™©": false };
            }
          } else {
            d[TASKS[t]] = {};
            for (day = 0; day < DAYS.length; day += 1){
              d[TASKS[t]][DAYS[day]] = false;
            }
          }
          if (TASKS[t] === CHO_WOL){
            d[CHO_WOL] = {};
            for (day = 0; day < DAYS.length; day += 1){
              d[CHO_WOL][DAYS[day]] = { "ë°ìš°ìŠ¤": 0, "ì•„ë¥´ì¹´ë‹ˆìŠ¤": 0 };
            }
          }
        }
        return d;
      }

      function buildDefaultOddEnergy(){
        return {
          normal: 0,
          charged: 0,
          lastBaseCharge: ""   // ë§ˆì§€ë§‰ ê¸°ë³¸ ì˜¤ë“œ ì¶©ì „ ê¸°ì¤€ ì‹œê°
        };
      }


      function buildDefaultCount(){
        return {
          base: 0,
          bonus: 0,
          used: 0,
          lastCharge: ""
        };
      }

      function buildDefaultConquestUsed(){
        var o = {};
        var i;
        for (i = 0; i < DAYS.length; i += 1){
          o[DAYS[i]] = 0;
        }
        return o;
      }

      function buildDefaultTranscendUsed(){
        var o = {};
        var i;
        for (i = 0; i < DAYS.length; i += 1){
          o[DAYS[i]] = { "ë°ìš°ìŠ¤": 0, "ì•„ë¥´ì¹´ë‹ˆìŠ¤": 0 };
        }
        return o;
      }

      function buildDefaultTranscendLog(){
        var o = {};
        var i;
        for (i = 0; i < DAYS.length; i += 1){
          o[DAYS[i]] = { "ë°ìš°ìŠ¤": [], "ì•„ë¥´ì¹´ë‹ˆìŠ¤": [] };
        }
        return o;
      }

      function buildDefaultConquestLog(){
        var o = {};
        var i;
        for (i = 0; i < DAYS.length; i += 1){
          o[DAYS[i]] = [];
        }
        return o;
      }

      function defaultStateData(chars){
        var data = {};
        var i;
        for (i = 0; i < chars.length; i += 1){
          data[chars[i]] = buildDefaultCharData();
        }
        return data;
      }

      function normalizeWeekly(payload){
        var c, charName, t, day;
        for (c = 0; c < payload.characters.length; c += 1){
          charName = payload.characters[c];
          for (t = 0; t < TASKS.length; t += 1){
            if (!isWeeklyTask(TASKS[t])) continue;

            var anyTrue = false;
            for (day = 0; day < DAYS.length; day += 1){
              if (payload.data[charName][TASKS[t]][DAYS[day]] === true){
                anyTrue = true;
              }
            }
            if (anyTrue){
              for (day = 0; day < DAYS.length; day += 1){
                payload.data[charName][TASKS[t]][DAYS[day]] = true;
              }
            }
          }
        }
      }

      function migrateFromLegacyPayload(parsed){
        if (parsed && parsed.data && parsed.characters && Array.isArray(parsed.characters)){
          return parsed;
        }

        var migrated = {
          characters: DEFAULT_CHARACTERS.slice(0),
          activeChar: DEFAULT_CHARACTERS[0],
          viewMode: "today",
          data: defaultStateData(DEFAULT_CHARACTERS),
          oddEnergy: {},
          conquestUsed: {},
          conquestSpendLog: {},
          transcendUsed: {},
          transcendSpendLog: {},
          counts: {},
          charMeta: {}
        };

        if (!parsed || typeof parsed !== "object"){
          return migrated;
        }

        if (parsed.data && typeof parsed.data === "object"){
          var legacyKeys = Object.keys(parsed.data);
          if (legacyKeys.length > 0){
            migrated.characters = legacyKeys.slice(0);
            migrated.activeChar = parsed.activeJob || legacyKeys[0];
            migrated.viewMode = parsed.viewMode === "all" ? "all" : "today";
            migrated.data = {};
            migrated.oddEnergy = {};
            migrated.conquestUsed = {};
            migrated.conquestSpendLog = {};
            migrated.transcendUsed = {};
            migrated.transcendSpendLog = {};
            migrated.counts = {};
            migrated.charMeta = {};

            var i;
            for (i = 0; i < legacyKeys.length; i += 1){
              migrated.data[legacyKeys[i]] = buildDefaultCharData();
              migrated.oddEnergy[legacyKeys[i]] = buildDefaultOddEnergy();
              migrated.conquestUsed[legacyKeys[i]] = buildDefaultConquestUsed();
              migrated.conquestSpendLog[legacyKeys[i]] = buildDefaultConquestLog();
              migrated.transcendUsed[legacyKeys[i]] = buildDefaultTranscendUsed();
              migrated.transcendSpendLog[legacyKeys[i]] = buildDefaultTranscendLog();
              migrated.counts[legacyKeys[i]] = {
                nightmare: buildDefaultCount(),
                dailyDungeon: buildDefaultCount(),
                raid: buildDefaultCount(),
                awakening: buildDefaultCount()
              };
              migrated.charMeta[legacyKeys[i]] = { itemLevel: 0 };
            }

            var j, t, day, legacyChar, legacyObj;
            for (j = 0; j < legacyKeys.length; j += 1){
              legacyChar = legacyKeys[j];
              legacyObj = parsed.data[legacyChar];

              for (t = 0; t < TASKS.length; t += 1){
                if (TASKS[t] === HOERANG){
                  var legacyRoot = legacyObj["íšŒë‘-ë¿Œë¦¬"];
                  var legacyWing = legacyObj["íšŒë‘-ë‚ ê°œ"];
                  var legacySulfur = legacyObj["íšŒë‘-ìœ í™©"];
                  var legacyOne = legacyObj["íšŒë‘"];

                  for (day = 0; day < DAYS.length; day += 1){
                    if (legacyOne && typeof legacyOne[DAYS[day]] === "boolean"){
                      migrated.data[legacyChar][HOERANG][DAYS[day]]["ë¿Œë¦¬"] = legacyOne[DAYS[day]];
                      migrated.data[legacyChar][HOERANG][DAYS[day]]["ë‚ ê°œ"] = legacyOne[DAYS[day]];
                      migrated.data[legacyChar][HOERANG][DAYS[day]]["ìœ í™©"] = legacyOne[DAYS[day]];
                    }
                    if (legacyRoot && typeof legacyRoot[DAYS[day]] === "boolean"){
                      migrated.data[legacyChar][HOERANG][DAYS[day]]["ë¿Œë¦¬"] = legacyRoot[DAYS[day]];
                    }
                    if (legacyWing && typeof legacyWing[DAYS[day]] === "boolean"){
                      migrated.data[legacyChar][HOERANG][DAYS[day]]["ë‚ ê°œ"] = legacyWing[DAYS[day]];
                    }
                    if (legacySulfur && typeof legacySulfur[DAYS[day]] === "boolean"){
                      migrated.data[legacyChar][HOERANG][DAYS[day]]["ìœ í™©"] = legacySulfur[DAYS[day]];
                    }
                  }
                  continue;
                }

                if (legacyObj[TASKS[t]] && typeof legacyObj[TASKS[t]] === "object"){
                  for (day = 0; day < DAYS.length; day += 1){
                    if (typeof legacyObj[TASKS[t]][DAYS[day]] === "boolean"){
                      migrated.data[legacyChar][TASKS[t]][DAYS[day]] = legacyObj[TASKS[t]][DAYS[day]];
                    }
                  }
                }
              }
            }

            normalizeWeekly(migrated);
          }
        }

        return migrated;
      }

      function pickRaw(){
        var raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return raw;

        var i;
        for (i = 0; i < FALLBACK_KEYS.length; i += 1){
          raw = localStorage.getItem(FALLBACK_KEYS[i]);
          if (raw) return raw;
        }
        return "";
      }

      function load(){
        state.today = getTodayKoreanDay();

        var raw = pickRaw();
        if (!raw){
          state.characters = DEFAULT_CHARACTERS.slice(0);
          state.activeChar = state.characters[0];
          state.viewMode = "today";
          state.data = defaultStateData(state.characters);
          state.oddEnergy = {};
          state.conquestUsed = {};
          state.conquestSpendLog = {};
          state.transcendUsed = {};
          state.transcendSpendLog = {};
          state.counts = {};
          state.charMeta = {};

          var i;
          for (i = 0; i < state.characters.length; i += 1){
            var cn = state.characters[i];
            state.oddEnergy[cn] = buildDefaultOddEnergy();
            state.conquestUsed[cn] = buildDefaultConquestUsed();
            state.conquestSpendLog[cn] = buildDefaultConquestLog();
            state.transcendUsed[cn] = buildDefaultTranscendUsed();
            state.transcendSpendLog[cn] = buildDefaultTranscendLog();
            state.counts[cn] = {
              nightmare: buildDefaultCount(),
              dailyDungeon: buildDefaultCount(),
              raid: buildDefaultCount(),
              awakening: buildDefaultCount()
            };
            state.charMeta[cn] = { itemLevel: 0 };
          }

          save("ì´ˆê¸° ìƒì„±");
          return;
        }

        try{
          var parsed = JSON.parse(raw);
          var migrated = migrateFromLegacyPayload(parsed);

          state.characters = (migrated.characters && migrated.characters.length)
            ? migrated.characters.slice(0)
            : DEFAULT_CHARACTERS.slice(0);

          state.activeChar = migrated.activeChar || state.characters[0];
          state.viewMode = migrated.viewMode === "all" ? "all" : "today";

          state.data = migrated.data || {};
          state.charMeta = migrated.charMeta && typeof migrated.charMeta === "object" ? migrated.charMeta : {};
          state.oddEnergy = migrated.oddEnergy && typeof migrated.oddEnergy === "object" ? migrated.oddEnergy : {};
          state.conquestUsed = migrated.conquestUsed && typeof migrated.conquestUsed === "object" ? migrated.conquestUsed : {};
          state.conquestSpendLog = migrated.conquestSpendLog && typeof migrated.conquestSpendLog === "object" ? migrated.conquestSpendLog : {};
          state.counts = migrated.counts && typeof migrated.counts === "object" ? migrated.counts : {};
          state.transcendUsed = migrated.transcendUsed && typeof migrated.transcendUsed === "object" ? migrated.transcendUsed : {};
          state.transcendSpendLog = migrated.transcendSpendLog && typeof migrated.transcendSpendLog === "object" ? migrated.transcendSpendLog : {};

          var i;
          for (i = 0; i < state.characters.length; i += 1){
            var cn = state.characters[i];

            if (!state.data[cn]) state.data[cn] = buildDefaultCharData();

            if (!state.oddEnergy[cn]) state.oddEnergy[cn] = buildDefaultOddEnergy();
            if (typeof state.oddEnergy[cn].normal !== "number") state.oddEnergy[cn].normal = 0;
            if (typeof state.oddEnergy[cn].charged !== "number") state.oddEnergy[cn].charged = 0;

            if (!state.charMeta[cn]) state.charMeta[cn] = { itemLevel: 0 };
            if (typeof state.charMeta[cn].itemLevel !== "number") state.charMeta[cn].itemLevel = 0;

            if (!state.transcendUsed[cn]) state.transcendUsed[cn] = buildDefaultTranscendUsed();
            if (!state.transcendSpendLog[cn]) state.transcendSpendLog[cn] = buildDefaultTranscendLog();

            if (!state.conquestUsed[cn]) state.conquestUsed[cn] = buildDefaultConquestUsed();
            if (!state.conquestSpendLog[cn]) state.conquestSpendLog[cn] = buildDefaultConquestLog();

            if (!state.counts[cn]) {
              state.counts[cn] = {
                nightmare: buildDefaultCount(),
                dailyDungeon: buildDefaultCount(),
                raid: buildDefaultCount(),
                awakening: buildDefaultCount()
              };
            }
            if (!state.counts[cn].dailyDungeon) {
              state.counts[cn].dailyDungeon = buildDefaultCount();
            }

            var di;
            for (di = 0; di < DAYS.length; di += 1){
              var day = DAYS[di];
              if (typeof state.conquestUsed[cn][day] !== "number") state.conquestUsed[cn][day] = 0;
              if (!Array.isArray(state.conquestSpendLog[cn][day])) state.conquestSpendLog[cn][day] = [];
              if (!state.transcendUsed[cn][day]) state.transcendUsed[cn][day] = { "ë°ìš°ìŠ¤": 0, "ì•„ë¥´ì¹´ë‹ˆìŠ¤": 0 };
              if (!state.transcendSpendLog[cn][day]) state.transcendSpendLog[cn][day] = { "ë°ìš°ìŠ¤": [], "ì•„ë¥´ì¹´ë‹ˆìŠ¤": [] };
            }
          }

          if (state.characters.indexOf(state.activeChar) < 0){
            state.activeChar = state.characters[0];
          }

          normalizeWeekly({ characters: state.characters, data: state.data });

          save("ë¡œë“œ/ì •ê·œí™”");
        } catch(e){
          state.characters = DEFAULT_CHARACTERS.slice(0);
          state.activeChar = state.characters[0];
          state.viewMode = "today";
          state.data = defaultStateData(state.characters);
          state.oddEnergy = {};
          state.conquestUsed = {};
          state.conquestSpendLog = {};
          state.transcendUsed = {};
          state.transcendSpendLog = {};
          state.counts = {};
          state.charMeta = {};

          var i;
          for (i = 0; i < state.characters.length; i += 1){
            var cn = state.characters[i];
            state.oddEnergy[cn] = buildDefaultOddEnergy();
            state.conquestUsed[cn] = buildDefaultConquestUsed();
            state.conquestSpendLog[cn] = buildDefaultConquestLog();
            state.transcendUsed[cn] = buildDefaultTranscendUsed();
            state.transcendSpendLog[cn] = buildDefaultTranscendLog();
            state.counts[cn] = {
              nightmare: buildDefaultCount(),
              dailyDungeon: buildDefaultCount(),
              raid: buildDefaultCount(),
              awakening: buildDefaultCount()
            };
            state.charMeta[cn] = { itemLevel: 0 };
          }

          save("ì†ìƒ ë³µêµ¬(ì´ˆê¸°í™”)");
        }
      }

      function save(reason){
        var payload = {
          characters: state.characters.slice(0),
          activeChar: state.activeChar,
          viewMode: state.viewMode,
          data: state.data,

          oddEnergy: state.oddEnergy,
          conquestUsed: state.conquestUsed,
          conquestSpendLog: state.conquestSpendLog,

          transcendUsed: state.transcendUsed,
          transcendSpendLog: state.transcendSpendLog,

          counts: state.counts,
          charMeta: state.charMeta,
          meta: { savedAt: nowIso(), reason: reason || "auto" }
        };
        
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        updateSavedLabel(payload.meta.savedAt);
        fbSave(payload);   // ğŸ”¥ Firebase ë™ê¸°í™”
      }

      function loadShugoPrefs(){
        try{
          var raw = localStorage.getItem(SHUGO_PREF_KEY);
          if (!raw) return;

          var parsed = JSON.parse(raw);
          if (parsed && typeof parsed.enabled === "boolean"){
            shugoPrefs.enabled = parsed.enabled;
          }
        } catch(e){}
      }

      function saveShugoPrefs(){
        try{
          localStorage.setItem(SHUGO_PREF_KEY, JSON.stringify({ enabled: !!shugoPrefs.enabled }));
        } catch(e){}
      }

      function updateSavedLabel(iso){
        var el = document.getElementById("lastSavedLabel");
        if (!el) return;
        try{ el.textContent = new Date(iso).toLocaleString(); }
        catch(e){ el.textContent = iso; }
      }

      function setActiveChar(name){
        state.activeChar = name;
        save("ìºë¦­í„° ë³€ê²½");
        render();
      }

      function toggleViewMode(){
        state.viewMode = (state.viewMode === "today") ? "all" : "today";
        save("ë³´ê¸° ëª¨ë“œ ë³€ê²½");
        render();
      }

      function getVisibleDays(){
        if (state.viewMode === "today"){
          return [state.today];
        }
        return DAYS.slice(0);
      }

      function normalizeCharName(name){
        if (!name) return "";
        name = String(name);
        name = name.replace(/\s+/g," ").trim();
        return name;
      }

      function ensureCharStructures(charName){
        if (!state.data[charName]) state.data[charName] = buildDefaultCharData();
        if (!state.oddEnergy[charName]) state.oddEnergy[charName] = buildDefaultOddEnergy();
        if (!state.conquestUsed[charName]) state.conquestUsed[charName] = buildDefaultConquestUsed();
        if (!state.conquestSpendLog[charName]) state.conquestSpendLog[charName] = buildDefaultConquestLog();

        if (!state.transcendUsed[charName]) state.transcendUsed[charName] = buildDefaultTranscendUsed();
        if (!state.transcendSpendLog[charName]) state.transcendSpendLog[charName] = buildDefaultTranscendLog();

        var di;
        for (di = 0; di < DAYS.length; di += 1){
          var day = DAYS[di];
          if (typeof state.conquestUsed[charName][day] !== "number") state.conquestUsed[charName][day] = 0;
          if (!Array.isArray(state.conquestSpendLog[charName][day])) state.conquestSpendLog[charName][day] = [];
          if (!state.transcendUsed[charName][day]) state.transcendUsed[charName][day] = { "ë°ìš°ìŠ¤": 0, "ì•„ë¥´ì¹´ë‹ˆìŠ¤": 0 };
          if (!state.transcendSpendLog[charName][day]) state.transcendSpendLog[charName][day] = { "ë°ìš°ìŠ¤": [], "ì•„ë¥´ì¹´ë‹ˆìŠ¤": [] };
        }

        if (!state.counts[charName]) {
          state.counts[charName] = {
            nightmare: buildDefaultCount(),
            dailyDungeon: buildDefaultCount(),
            raid: buildDefaultCount(),
            awakening: buildDefaultCount()
          };
        }
        if (!state.counts[charName].dailyDungeon) {
          state.counts[charName].dailyDungeon = buildDefaultCount();
        }

        if (!state.charMeta[charName]) {
          state.charMeta[charName] = { itemLevel: 0 };
        }
        if (typeof state.charMeta[charName].itemLevel !== "number") {
          state.charMeta[charName].itemLevel = 0;
        }
      }

      function addCharacter(){
        var name = prompt("ì¶”ê°€í•  ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì¤‘ë³µ ë¶ˆê°€)");
        if (name === null) return;

        name = normalizeCharName(name);
        if (name === ""){
          alert("ì´ë¦„ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
          return;
        }
        if (state.characters.indexOf(name) >= 0){
          alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.");
          return;
        }

        state.characters.push(name);
        ensureCharStructures(name);

        state.activeChar = name;

        save("ìºë¦­í„° ì¶”ê°€ (" + name + ")");
        render();
      }

      function renameCurrentCharacter(){
        var oldName = state.activeChar;
        var input = prompt("ìƒˆ ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”", oldName);
        if (input === null) return;

        var newName = normalizeCharName(input);
        if (newName === ""){
          alert("ì´ë¦„ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
          return;
        }
        if (newName === oldName) return;
        if (state.characters.indexOf(newName) >= 0){
          alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.");
          return;
        }

        var idx = state.characters.indexOf(oldName);
        if (idx < 0){
          alert("í˜„ì¬ ìºë¦­í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        state.characters[idx] = newName;

        state.data[newName] = state.data[oldName] ? state.data[oldName] : buildDefaultCharData();
        if (state.data[oldName]) delete state.data[oldName];

        state.oddEnergy[newName] = state.oddEnergy[oldName] ? state.oddEnergy[oldName] : buildDefaultOddEnergy();
        if (state.oddEnergy[oldName]) delete state.oddEnergy[oldName];

        state.conquestUsed[newName] = state.conquestUsed[oldName] ? state.conquestUsed[oldName] : buildDefaultConquestUsed();
        if (state.conquestUsed[oldName]) delete state.conquestUsed[oldName];

        state.conquestSpendLog[newName] = state.conquestSpendLog[oldName] ? state.conquestSpendLog[oldName] : buildDefaultConquestLog();
        if (state.conquestSpendLog[oldName]) delete state.conquestSpendLog[oldName];

        state.transcendUsed[newName] = state.transcendUsed[oldName] ? state.transcendUsed[oldName] : buildDefaultTranscendUsed();
        if (state.transcendUsed[oldName]) delete state.transcendUsed[oldName];

        state.transcendSpendLog[newName] = state.transcendSpendLog[oldName] ? state.transcendSpendLog[oldName] : buildDefaultTranscendLog();
        if (state.transcendSpendLog[oldName]) delete state.transcendSpendLog[oldName];

        state.counts[newName] = state.counts[oldName] ? state.counts[oldName] : {
          nightmare: buildDefaultCount(),
          dailyDungeon: buildDefaultCount(),
          raid: buildDefaultCount(),
          awakening: buildDefaultCount()
        };
        if (state.counts[oldName]) delete state.counts[oldName];

        state.charMeta[newName] = state.charMeta[oldName] ? state.charMeta[oldName] : { itemLevel: 0 };
        if (state.charMeta[oldName]) delete state.charMeta[oldName];

        state.activeChar = newName;

        save("ìºë¦­í„° ë¦¬ë„¤ì„ (" + oldName + " -> " + newName + ")");
        render();
      }

      function removeCurrentCharacter(){
        if (state.characters.length <= 1){
          alert("ìµœì†Œ 1ê°œì˜ ìºë¦­í„°ëŠ” ë‚¨ì•„ìˆì–´ì•¼ í•©ë‹ˆë‹¤.");
          return;
        }

        var target = state.activeChar;
        var ok = confirm("[" + target + "] ìºë¦­í„°ë¥¼ ì‚­ì œí• ê¹Œìš”? (í•´ë‹¹ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œ)");
        if (!ok) return;

        var idx = state.characters.indexOf(target);
        if (idx >= 0) state.characters.splice(idx, 1);

        if (state.data[target]) delete state.data[target];
        if (state.oddEnergy[target]) delete state.oddEnergy[target];
        if (state.conquestUsed[target]) delete state.conquestUsed[target];
        if (state.conquestSpendLog[target]) delete state.conquestSpendLog[target];
        if (state.transcendUsed[target]) delete state.transcendUsed[target];
        if (state.transcendSpendLog[target]) delete state.transcendSpendLog[target];
        if (state.counts[target]) delete state.counts[target];
        if (state.charMeta[target]) delete state.charMeta[target];

        var newIdx = idx;
        if (newIdx >= state.characters.length) newIdx = state.characters.length - 1;
        state.activeChar = state.characters[newIdx];

        save("ìºë¦­í„° ì‚­ì œ (" + target + ")");
        render();
      }

      function getValue(charName, taskName, dayName, partName){
        if (!state.data[charName]) return false;

        if (taskName === HOERANG){
          var cell = state.data[charName][HOERANG] && state.data[charName][HOERANG][dayName];
          if (!cell || typeof cell !== "object") return false;
          return cell[partName] === true;
        }

        var t = state.data[charName][taskName];
        if (!t || typeof t !== "object") return false;
        return t[dayName] === true;
      }

      function setValue(charName, taskName, dayName, value, partName){
        ensureCharStructures(charName);

        if (taskName === HOERANG){
          var cell = state.data[charName][HOERANG][dayName];
          if (!cell || typeof cell !== "object"){
            state.data[charName][HOERANG][dayName] = { "ë¿Œë¦¬": false, "ë‚ ê°œ": false, "ìœ í™©": false };
          }
          state.data[charName][HOERANG][dayName][partName] = value ? true : false;
          return;
        }

        if (isWeeklyTask(taskName)){
          var di;
          for (di = 0; di < DAYS.length; di += 1){
            state.data[charName][taskName][DAYS[di]] = value ? true : false;
          }
          return;
        }

        state.data[charName][taskName][dayName] = value ? true : false;
      }

      function setAllForDay(charName, dayName, value){
        var t, part;
        for (t = 0; t < TASKS.length; t += 1){
          if (TASKS[t] === "ì •ë³µ"){
            continue;
          }

          if (TASKS[t] === HOERANG){
            for (part = 0; part < HOERANG_PARTS.length; part += 1){
              setValue(charName, HOERANG, dayName, value, HOERANG_PARTS[part]);
            }
            continue;
          }
          setValue(charName, TASKS[t], dayName, value);
        }
      }

      function resetChar(charName){
        state.data[charName] = buildDefaultCharData();
        state.oddEnergy[charName] = buildDefaultOddEnergy();
        state.conquestUsed[charName] = buildDefaultConquestUsed();
        state.conquestSpendLog[charName] = buildDefaultConquestLog();
        state.transcendUsed[charName] = buildDefaultTranscendUsed();
        state.transcendSpendLog[charName] = buildDefaultTranscendLog();
        state.counts[charName] = {
          nightmare: buildDefaultCount(),
          dailyDungeon: buildDefaultCount(),
          raid: buildDefaultCount(),
          awakening: buildDefaultCount()
        };
        state.charMeta[charName] = { itemLevel: 0 };

        save("ìºë¦­í„° ì´ˆê¸°í™” (" + charName + ")");
        render();
      }

      function resetAll(){
        state.data = defaultStateData(state.characters);
        state.oddEnergy = {};
        state.conquestUsed = {};
        state.conquestSpendLog = {};
        state.transcendUsed = {};
        state.transcendSpendLog = {};
        state.counts = {};
        state.charMeta = {};

        var i;
        for (i = 0; i < state.characters.length; i += 1){
          var cn = state.characters[i];
          state.oddEnergy[cn] = buildDefaultOddEnergy();
          state.conquestUsed[cn] = buildDefaultConquestUsed();
          state.conquestSpendLog[cn] = buildDefaultConquestLog();
          state.transcendUsed[cn] = buildDefaultTranscendUsed();
          state.transcendSpendLog[cn] = buildDefaultTranscendLog();
          state.counts[cn] = {
            nightmare: buildDefaultCount(),
            dailyDungeon: buildDefaultCount(),
            raid: buildDefaultCount(),
            awakening: buildDefaultCount()
          };
          state.charMeta[cn] = { itemLevel: 0 };
        }

        save("ì „ì²´ ì´ˆê¸°í™”");
        render();
      }

      function exportJson(){
        var raw = localStorage.getItem(STORAGE_KEY) || "";
        if (!raw){
          alert("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }
        var blob = new Blob([raw], { type: "application/json;charset=utf-8" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "dailyQuest_backup.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(function(){ URL.revokeObjectURL(url); }, 250);
      }

      function importJson(){
        var input = document.createElement("input");
        input.type = "file";
        input.accept = "application/json";
        input.addEventListener("change", function(){
          var file = input.files && input.files[0];
          if (!file) return;

          var reader = new FileReader();
          reader.onload = function(){
            try{
              var parsed = JSON.parse(String(reader.result || ""));
              if (!parsed || typeof parsed !== "object"){
                alert("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
              }

              if (parsed.characters && parsed.data){
                state.characters = parsed.characters.slice(0);
                state.activeChar = parsed.activeChar || state.characters[0];
                state.viewMode = parsed.viewMode === "all" ? "all" : "today";

                state.data = parsed.data || {};
                state.oddEnergy = parsed.oddEnergy || {};
                state.conquestUsed = parsed.conquestUsed || {};
                state.conquestSpendLog = parsed.conquestSpendLog || {};

                state.transcendUsed = parsed.transcendUsed || {};
                state.transcendSpendLog = parsed.transcendSpendLog || {};

                state.counts = parsed.counts || {};
                state.charMeta = parsed.charMeta || {};
              } else {
                var migrated = migrateFromLegacyPayload(parsed);
                state.characters = migrated.characters.slice(0);
                state.activeChar = migrated.activeChar || state.characters[0];
                state.viewMode = migrated.viewMode === "all" ? "all" : "today";

                state.data = migrated.data || {};
                state.oddEnergy = migrated.oddEnergy || {};
                state.conquestUsed = migrated.conquestUsed || {};
                state.conquestSpendLog = migrated.conquestSpendLog || {};

                state.transcendUsed = migrated.transcendUsed || {};
                state.transcendSpendLog = migrated.transcendSpendLog || {};

                state.counts = migrated.counts || {};
                state.charMeta = migrated.charMeta || {};
              }

              var i;
              for (i = 0; i < state.characters.length; i += 1){
                ensureCharStructures(state.characters[i]);
              }

              if (state.characters.indexOf(state.activeChar) < 0){
                state.activeChar = state.characters[0];
              }

              normalizeWeekly({ characters: state.characters, data: state.data });

              save("ë³µì› ê°€ì ¸ì˜¤ê¸°");
              render();
              alert("ë³µì› ì™„ë£Œ!");
            } catch(e){
              alert("JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            }
          };
          reader.readAsText(file, "utf-8");
        });
        input.click();
      }

      function getOddTotal(charName){
        ensureCharStructures(charName);
        return (state.oddEnergy[charName].normal || 0) + (state.oddEnergy[charName].charged || 0);
      }

      function spendOddBlocks(charName, logArr, blocks){
        var i;
        for (i = 0; i < blocks; i += 1){
          if (state.oddEnergy[charName].normal >= 40){
            state.oddEnergy[charName].normal -= 40;
            logArr.push("normal");
          } else if (state.oddEnergy[charName].charged >= 40){
            state.oddEnergy[charName].charged -= 40;
            logArr.push("charged");
          } else {
            return false;
          }
        }
        return true;
      }

      function getConquestPossible(charName){
        var total = getOddTotal(charName);
        return Math.floor(total / 40);
      }

      function getOddChargeSlot(date){
        var d = new Date(date);
        d.setMinutes(0, 0, 0);
        var h = d.getHours();
        d.setHours(Math.floor(h / 3) * 3);
        return d;
      }

      function autoChargeBaseOdd(char){
        ensureCharStructures(char);

        var odd = state.oddEnergy[char];
        var now = Date.now();

        if (!odd.lastBaseCharge){
            return;
        }

        var last = new Date(odd.lastBaseCharge).getTime();
        var interval = 3 * 60 * 60 * 1000; // 3ì‹œê°„

        var passed = now - last;
        if (passed < interval) return;

        var count = Math.floor(passed / interval);
        if (count <= 0) return;

        odd.normal = Math.min(840, odd.normal + count * 15);

        odd.lastBaseCharge = new Date(last + count * interval).toISOString();
        save("ê¸°ë³¸ ì˜¤ë“œ ìë™ ì¶©ì „");
      }

      function getNextOddChargeTime(char){
        ensureCharStructures(char);
        var odd = state.oddEnergy[char];

        var base = odd.lastBaseCharge
          ? new Date(odd.lastBaseCharge)
          : new Date();

        var next = new Date(base.getTime() + 3 * 60 * 60 * 1000);
        return next;
      }

      function formatRemain(ms){
        if (ms < 0) ms = 0;
        var m = Math.floor(ms / 60000);
        var h = Math.floor(m / 60);
        return h + "ì‹œê°„ " + (m % 60) + "ë¶„";
      }

      function pad2(n){
        n = parseInt(n, 10);
        if (isNaN(n) || n < 0) n = 0;
        return (n < 10) ? ("0" + n) : String(n);
      }

      function formatTimeHM(dateObj){
        try{
          var d = new Date(dateObj);
          return pad2(d.getHours()) + ":" + pad2(d.getMinutes());
        } catch(e){
          return "-";
        }
      }

      function autoChargeNightmare(char){
        var c = state.counts[char].nightmare;

        var now = new Date();
        var six = new Date();
        six.setHours(6,0,0,0);
        if (now < six) six.setDate(six.getDate() - 1);

        var key = six.toISOString();
        if (c.lastCharge === key) return;

        c.base = Math.min(14, c.base + 2);
        c.lastCharge = key;
        save("ì•…ëª½ ìë™ì¶©ì „");
      }



      function autoChargeWeekly(char, type){
        var c = state.counts[char][type];

        var now = new Date();
        var w = new Date(now);
        w.setDate(w.getDate() - w.getDay() + 3); // ìˆ˜ìš”ì¼
        w.setHours(6,0,0,0);
        if (now < w) w.setDate(w.getDate() - 7);

        var key = w.toISOString();
        if (c.lastCharge === key) return;

        c.base = Math.min(3, c.base + 3);
        c.lastCharge = key;
        save(type + " ìë™ì¶©ì „");
      }

      // âœ… ì¼ì¼ë˜ì „: ë§¤ì£¼ ìˆ˜ìš”ì¼ 05:00, ê¸°ë³¸ì…ì¥ê¶Œ 7ì¥(ìµœëŒ€7)ìœ¼ë¡œ ë¦¬í•„, usedëŠ” ì£¼ê°„ ê¸°ì¤€ìœ¼ë¡œ ë¦¬ì…‹
      function autoChargeDailyDungeon(char){
        var c = state.counts[char].dailyDungeon;

        var now = new Date();
        var w = new Date(now);
        w.setDate(w.getDate() - w.getDay() + 3); // ìˆ˜ìš”ì¼
        w.setHours(5,0,0,0);
        if (now < w) w.setDate(w.getDate() - 7);

        var key = w.toISOString();
        if (c.lastCharge === key) return;

        c.base = 7;
        if (typeof c.used !== "number" || c.used < 0) c.used = 0;
        c.used = 0;     // ì£¼ê°„ ë¦¬ì…‹
        c.lastCharge = key;

        save("ì¼ì¼ë˜ì „ ìë™ì¶©ì „");
      }

      function runAutoCharges(){
        var char = state.activeChar;
        ensureCharStructures(char);
        autoChargeBaseOdd(char);   // ğŸ”¥ ì¶”ê°€
        autoChargeNightmare(char);
        autoChargeWeekly(char, "raid");
        autoChargeWeekly(char, "awakening");
        autoChargeDailyDungeon(char);
      }

      function getAvailableCount(c){
        return Math.max(0, (c.base || 0) + (c.bonus || 0) - (c.used || 0));
      }

      function adjustCount(char, type, delta){
        var c = state.counts[char][type];

        if (delta > 0) {
          if (getAvailableCount(c) <= 0) return;
          c.used += 1;
        } else {
          if (c.used <= 0) return;
          c.used -= 1;
        }
        save(type + " ìˆ˜ë™ì¡°ì •");
      }

      function conquestInc40(charName, dayName){
        ensureCharStructures(charName);

        if (getOddTotal(charName) < 40) return false;

        var logArr = state.conquestSpendLog[charName][dayName];
        var ok = spendOddBlocks(charName, logArr, 1);
        if (!ok) return false;

        state.conquestUsed[charName][dayName] += 1;
        save("ì •ë³µ +1 (" + dayName + ")");
        return true;
      }

      function conquestInc80(charName, dayName){
        ensureCharStructures(charName);

        if (getOddTotal(charName) < 80) return false;

        var logArr = state.conquestSpendLog[charName][dayName];
        var ok = spendOddBlocks(charName, logArr, 2);
        if (!ok) return false;

        state.conquestUsed[charName][dayName] += 2;
        save("ì •ë³µ +2 (" + dayName + ")");
        return true;
      }

      function conquestDec(charName, dayName){
        ensureCharStructures(charName);

        if (state.conquestUsed[charName][dayName] <= 0){
          return false;
        }

        state.conquestUsed[charName][dayName] -= 1;

        var logArr = state.conquestSpendLog[charName][dayName];
        var lastType = "";
        if (Array.isArray(logArr) && logArr.length > 0){
          lastType = logArr.pop();
        }

        if (lastType === "charged"){
          state.oddEnergy[charName].charged += 40;
        } else {
          state.oddEnergy[charName].normal += 40;
        }

        save("ì •ë³µ -1 (" + dayName + ")");
        return true;
      }

      function transcendInc(charName, dayName, part){
        ensureCharStructures(charName);

        if (getOddTotal(charName) < 40) return false;

        if (state.oddEnergy[charName].normal >= 40){
          state.oddEnergy[charName].normal -= 40;
          state.transcendSpendLog[charName][dayName][part].push("normal");
        } else {
          state.oddEnergy[charName].charged -= 40;
          state.transcendSpendLog[charName][dayName][part].push("charged");
        }

        state.transcendUsed[charName][dayName][part] += 1;
        save("ì´ˆì›” +1 " + part);
        return true;
      }

      function transcendInc80(charName, dayName, part){
        ensureCharStructures(charName);

        if (getOddTotal(charName) < 80) return false;

        var logArr = state.transcendSpendLog[charName][dayName][part];
        var ok = spendOddBlocks(charName, logArr, 2);
        if (!ok) return false;

        state.transcendUsed[charName][dayName][part] += 2;
        save("ì´ˆì›” +2 " + part);
        return true;
      }

      function transcendDec(charName, dayName, part){
        ensureCharStructures(charName);

        if (state.transcendUsed[charName][dayName][part] <= 0) return false;

        state.transcendUsed[charName][dayName][part] -= 1;
        var last = state.transcendSpendLog[charName][dayName][part].pop() || "normal";
        if (last !== "normal" && last !== "charged") last = "normal";
        state.oddEnergy[charName][last] += 40;

        save("ì´ˆì›” -1 " + part);
        return true;
      }

      function getConquestTotalRuns(charName){
        ensureCharStructures(charName);
        var sum = 0;
        var i;
        for (i = 0; i < DAYS.length; i += 1){
          sum += state.conquestUsed[charName][DAYS[i]] || 0;
        }
        return sum;
      }

      function renderTabs(){
        var tabs = document.getElementById("tabs");
        var dragTabIndex = -1;
        tabs.innerHTML = "";

        var i;
        for (i = 0; i < state.characters.length; i += 1){
          var name = state.characters[i];

          var btn = document.createElement("div");
          btn.className = "tab" + (state.activeChar === name ? " active" : "");
          btn.draggable = true;

          btn.textContent = name;
          btn.setAttribute("role","button");
          btn.setAttribute("tabindex","0");

          (function(charName, el){
            el.addEventListener("dragstart", function(){
              dragTabIndex = state.characters.indexOf(charName);
              el.classList.add("dragging");
            });

            el.addEventListener("dragend", function(){
              el.classList.remove("dragging");
              dragTabIndex = -1;
            });

            el.addEventListener("dragover", function(ev){
              ev.preventDefault(); // drop í—ˆìš©
            });

            el.addEventListener("drop", function(){
              var dropIndex = state.characters.indexOf(charName);
              if (dragTabIndex < 0 || dropIndex < 0 || dragTabIndex === dropIndex) return;

              var moved = state.characters.splice(dragTabIndex, 1)[0];
              state.characters.splice(dropIndex, 0, moved);

              save("ìºë¦­í„° ìˆœì„œ ë³€ê²½");
              render();
            });

            el.addEventListener("click", function(){
              setActiveChar(charName);
            });
          })(name, btn);

          tabs.appendChild(btn);
        }

        var spacer = document.createElement("div");
        spacer.className = "spacer";
        tabs.appendChild(spacer);
      }

      function renderHeader(){
        document.getElementById("currentCharLabel").textContent = state.activeChar;
        document.getElementById("todayLabel").innerHTML = "<strong>" + state.today + "</strong>ìš”ì¼";

        var toggleBtn = document.getElementById("toggleViewBtn");
        toggleBtn.textContent = (state.viewMode === "today") ? "ì „ì²´ ë³´ê¸°" : "ì˜¤ëŠ˜ë§Œ ë³´ê¸°";

        ensureCharStructures(state.activeChar);
      }

      function openEditModal(){
        ensureCharStructures(state.activeChar);
        state.__oddCalibPromptedOnce = false;

        var modal = document.getElementById("editModal");
        modal.style.display = "flex";
        modal.setAttribute("aria-hidden", "false");

        var char = state.activeChar;

        document.getElementById("editName").value = char;

        document.getElementById("editItemLevel").value =
          (state.charMeta[char] && typeof state.charMeta[char].itemLevel === "number")
            ? state.charMeta[char].itemLevel
            : 0;

        document.getElementById("editOddNormal").value = state.oddEnergy[char].normal || 0;
        document.getElementById("editOddCharged").value = state.oddEnergy[char].charged || 0;

        var nm = state.counts[char].nightmare;
        var dd = state.counts[char].dailyDungeon;
        var aw = state.counts[char].awakening;
        var rd = state.counts[char].raid;

        document.getElementById("editNightmareBase").value = nm.base || 0;
        document.getElementById("editNightmareBonus").value = nm.bonus || 0;

        document.getElementById("editDailyDungeonBase").value = dd.base || 0;
        document.getElementById("editDailyDungeonBonus").value = dd.bonus || 0;

        document.getElementById("editAwakeningBase").value = aw.base || 0;
        document.getElementById("editAwakeningBonus").value = aw.bonus || 0;

        document.getElementById("editRaidBase").value = rd.base || 0;
        document.getElementById("editRaidBonus").value = rd.bonus || 0;

        setTotalsInEditModal(char);
        bindEditTotalLiveOnce();
      }

      function setTotalsInEditModal(char){
        var oddN = state.oddEnergy[char].normal || 0;
        var oddC = state.oddEnergy[char].charged || 0;

        var nm = state.counts[char].nightmare;
        var dd = state.counts[char].dailyDungeon;
        var aw = state.counts[char].awakening;
        var rd = state.counts[char].raid;

        var elOddTotal = document.getElementById("editOddTotal");
        if (elOddTotal) elOddTotal.value = (oddN + oddC);

        var elNmTotal = document.getElementById("editNightmareTotal");
        if (elNmTotal) elNmTotal.value = (nm.base + nm.bonus);

        var elDdTotal = document.getElementById("editDailyDungeonTotal");
        if (elDdTotal) elDdTotal.value = (dd.base + dd.bonus);

        var elAwTotal = document.getElementById("editAwakeningTotal");
        if (elAwTotal) elAwTotal.value = (aw.base + aw.bonus);

        var elRdTotal = document.getElementById("editRaidTotal");
        if (elRdTotal) elRdTotal.value = (rd.base + rd.bonus);
      }

      function closeEditModal(){
        var modal = document.getElementById("editModal");
        modal.style.display = "none";
        modal.setAttribute("aria-hidden", "true");
      }

      function readInt(id){
        var el = document.getElementById(id);
        if (!el) return 0;
        var v = parseInt(el.value, 10);
        if (isNaN(v) || v < 0) v = 0;
        return v;
      }

      function saveEditModal(){
        var oldName = state.activeChar;
        var newName = normalizeCharName(document.getElementById("editName").value);

        if (newName === ""){
          alert("ìºë¦­í„° ì´ë¦„ì´ ë¹„ì—ˆìŠµë‹ˆë‹¤.");
          return;
        }

        if (newName !== oldName && state.characters.indexOf(newName) >= 0){
          alert("ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë¦„ì…ë‹ˆë‹¤.");
          return;
        }

        var itemLevel = readInt("editItemLevel");
        var oddN = readInt("editOddNormal");
        var oddC = readInt("editOddCharged");

        var nmBase = readInt("editNightmareBase");
        var nmBonus = readInt("editNightmareBonus");

        var ddBase = readInt("editDailyDungeonBase");
        var ddBonus = readInt("editDailyDungeonBonus");

        var awBase = readInt("editAwakeningBase");
        var awBonus = readInt("editAwakeningBonus");

        var rdBase = readInt("editRaidBase");
        var rdBonus = readInt("editRaidBonus");

        // (1) ì´ë¦„ ë³€ê²½ ì²˜ë¦¬
        if (newName !== oldName){
          var idx = state.characters.indexOf(oldName);
          if (idx >= 0) state.characters[idx] = newName;

          state.data[newName] = state.data[oldName]; delete state.data[oldName];
          state.oddEnergy[newName] = state.oddEnergy[oldName]; delete state.oddEnergy[oldName];
          state.conquestUsed[newName] = state.conquestUsed[oldName]; delete state.conquestUsed[oldName];
          state.conquestSpendLog[newName] = state.conquestSpendLog[oldName]; delete state.conquestSpendLog[oldName];

          state.transcendUsed[newName] = state.transcendUsed[oldName]; delete state.transcendUsed[oldName];
          state.transcendSpendLog[newName] = state.transcendSpendLog[oldName]; delete state.transcendSpendLog[oldName];

          state.counts[newName] = state.counts[oldName]; delete state.counts[oldName];

          state.charMeta[newName] = state.charMeta[oldName] ? state.charMeta[oldName] : { itemLevel: 0 };
          if (state.charMeta[oldName]) delete state.charMeta[oldName];

          state.activeChar = newName;
        }

        // (2) ê°’ ë°˜ì˜
        ensureCharStructures(state.activeChar);

        state.charMeta[state.activeChar].itemLevel = itemLevel;

        state.oddEnergy[state.activeChar].normal = oddN;
        state.oddEnergy[state.activeChar].charged = oddC;

        var nm = state.counts[state.activeChar].nightmare;
        var dd = state.counts[state.activeChar].dailyDungeon;
        var aw = state.counts[state.activeChar].awakening;
        var rd = state.counts[state.activeChar].raid;

        nm.base = nmBase;
        nm.bonus = nmBonus;

        dd.base = ddBase;
        dd.bonus = ddBonus;

        aw.base = awBase;
        aw.bonus = awBonus;

        rd.base = rdBase;
        rd.bonus = rdBonus;

        // usedëŠ” ê¸°ì¡´ê°’ ìœ ì§€í•˜ë˜, ì´ë³´ìœ (base+bonus) ë„˜ì–´ê°€ë©´ clamp
        function clampUsed(counterObj){
          var total = (counterObj.base || 0) + (counterObj.bonus || 0);
          if (typeof counterObj.used !== "number" || counterObj.used < 0) counterObj.used = 0;
          if (counterObj.used > total) counterObj.used = total;
        }

        clampUsed(nm);
        clampUsed(dd);
        clampUsed(aw);
        clampUsed(rd);


        // (3) ì €ì¥ + ë‹«ê¸° + ë Œë”
        save("ìºë¦­í„° ì •ë³´ ìˆ˜ì •(ëª¨ë‹¬)");
        closeEditModal();
        render();
      }

      function renderSidePanel(){
        var char = state.activeChar;

        document.getElementById("sideCharName").textContent = char;

        document.getElementById("sideItemLevel").textContent =
          (state.charMeta[char] && typeof state.charMeta[char].itemLevel === "number")
            ? state.charMeta[char].itemLevel
            : 0;

        var oddTotal = getOddTotal(char);
        document.getElementById("sideOddTotal").textContent = oddTotal;

        var possible = Math.floor(oddTotal / 40);

        document.getElementById("sideConquest").textContent = possible + " íšŒ";
        document.getElementById("sideTranscend").textContent = possible + " íšŒ";

        var nm = state.counts[char].nightmare;
        var dd = state.counts[char].dailyDungeon;
        var aw = state.counts[char].awakening;
        var rd = state.counts[char].raid;

        document.getElementById("sideNightmareAvail").textContent = getAvailableCount(nm) + " íšŒ";
        document.getElementById("sideDailyDungeonAvail").textContent = getAvailableCount(dd) + " íšŒ";
        document.getElementById("sideAwakeningAvail").textContent = getAvailableCount(aw) + " íšŒ";
        document.getElementById("sideRaidAvail").textContent = getAvailableCount(rd) + " íšŒ";
        var next = getNextOddChargeTime(char);
        var remain = next - new Date();

        document.getElementById("sideOddNext").textContent =
          formatRemain(remain) + " í›„ (+15)";

        var atEl = document.getElementById("sideOddNextAt");
        if (atEl){
          atEl.textContent = formatTimeHM(next);
        }

      }

      function renderGrid(){
        var table = document.getElementById("gridTable");
        var visibleDays = getVisibleDays();
        table.innerHTML = "";

        var thead = document.createElement("thead");
        var tr = document.createElement("tr");

        var th = document.createElement("th");
        th.className = "taskCol";
        th.textContent = "ìˆ™ì œ";
        tr.appendChild(th);

        var d;
        for (d = 0; d < visibleDays.length; d += 1){
          var day = visibleDays[d];

          th = document.createElement("th");
          if (day === "í† " || day === "ì¼") th.classList.add("weekend");

          var headWrap = document.createElement("div");
          headWrap.className = "dayHead";

          var dayLabel = document.createElement("div");
          dayLabel.textContent = day;

          var btnWrap = document.createElement("div");
          btnWrap.className = "dayBtns";

          var allBtn = document.createElement("button");
          allBtn.type = "button";
          allBtn.textContent = "ì „ì²´ì²´í¬";

          var clearBtn = document.createElement("button");
          clearBtn.type = "button";
          clearBtn.textContent = "ì „ì²´í•´ì œ";

          (function(dayName){
            allBtn.addEventListener("click", function(){
              setAllForDay(state.activeChar, dayName, true);
              save("ìš”ì¼ ì „ì²´ ì²´í¬ (" + dayName + ")");
              render();
            });
            clearBtn.addEventListener("click", function(){
              setAllForDay(state.activeChar, dayName, false);
              save("ìš”ì¼ ì „ì²´ í•´ì œ (" + dayName + ")");
              render();
            });
          })(day);

          btnWrap.appendChild(allBtn);
          btnWrap.appendChild(clearBtn);

          headWrap.appendChild(dayLabel);
          headWrap.appendChild(btnWrap);

          th.appendChild(headWrap);
          tr.appendChild(th);
        }

        thead.appendChild(tr);
        table.appendChild(thead);

        var tbody = document.createElement("tbody");

        var t;
        for (t = 0; t < TASKS.length; t += 1){
          var taskName = TASKS[t];
          tr = document.createElement("tr");

          var nameTd = document.createElement("td");
          nameTd.className = "taskName";
          nameTd.textContent = taskName;

          if (isWeeklyTask(taskName)){
            var badge = document.createElement("span");
            badge.className = "badgeWeekly";
            badge.textContent = "ì£¼ 1íšŒ";
            nameTd.appendChild(badge);
          }

          tr.appendChild(nameTd);

          for (d = 0; d < visibleDays.length; d += 1){
            day = visibleDays[d];
            var td = document.createElement("td");

            // ===== ì •ë³µ =====
            if (taskName === "ì •ë³µ"){
              ensureCharStructures(state.activeChar);

              var box = document.createElement("div");
              box.className = "conqBox";

              var ctr = document.createElement("div");
              ctr.className = "conqCtr";

              var btnMinus = document.createElement("button");
              btnMinus.type = "button";
              btnMinus.textContent = "-";

              var countSpan = document.createElement("span");
              countSpan.textContent = (state.conquestUsed[state.activeChar][day] || 0) + "íšŒ";

              var btnPlus = document.createElement("button");
              btnPlus.type = "button";
              btnPlus.textContent = "+";

              var btnPlus2 = document.createElement("button");
              btnPlus2.type = "button";
              btnPlus2.className = "btn2x";
              btnPlus2.textContent = "2Ã—";
              btnPlus2.title = "2íšŒ ì¶”ê°€ (ì˜¤ë“œ 80)";

              btnMinus.disabled = (state.conquestUsed[state.activeChar][day] || 0) <= 0;
              btnPlus.disabled = getOddTotal(state.activeChar) < 40;
              btnPlus2.disabled = getOddTotal(state.activeChar) < 80;

              (function(dayName){
                btnPlus.addEventListener("click", function(){
                  var ok = conquestInc40(state.activeChar, dayName);
                  if (!ok) return;
                  render();
                });

                btnPlus2.addEventListener("click", function(){
                  var ok = conquestInc80(state.activeChar, dayName);
                  if (!ok) return;
                  render();
                });

                btnMinus.addEventListener("click", function(){
                  var ok = conquestDec(state.activeChar, dayName);
                  if (!ok) return;
                  render();
                });
              })(day);

              ctr.appendChild(btnMinus);
              ctr.appendChild(countSpan);
              ctr.appendChild(btnPlus);
              ctr.appendChild(btnPlus2);

              box.appendChild(ctr);
              td.appendChild(box);
              tr.appendChild(td);
              continue;
            }

            // ===== ì•…ëª½ =====
            if (taskName === "ì•…ëª½") {
              ensureCharStructures(state.activeChar);

              var boxN = document.createElement("div");
              boxN.className = "conqBox";

              var ctrN = document.createElement("div");
              ctrN.className = "conqCtr";

              var btnMinusN = document.createElement("button");
              btnMinusN.type = "button";
              btnMinusN.textContent = "-";

              var cN = state.counts[state.activeChar].nightmare;

              var countSpanN = document.createElement("span");
              countSpanN.textContent = cN.used + "íšŒ";

              var btnPlusN = document.createElement("button");
              btnPlusN.type = "button";
              btnPlusN.textContent = "+";

              var availableN = getAvailableCount(cN);

              btnMinusN.disabled = cN.used <= 0;
              btnPlusN.disabled = availableN <= 0;

              btnPlusN.addEventListener("click", function(){
                adjustCount(state.activeChar, "nightmare", +1);
                render();
              });

              btnMinusN.addEventListener("click", function(){
                adjustCount(state.activeChar, "nightmare", -1);
                render();
              });

              ctrN.appendChild(btnMinusN);
              ctrN.appendChild(countSpanN);
              ctrN.appendChild(btnPlusN);

              var infoN = document.createElement("div");
              infoN.className = "conqInfo";
              infoN.innerHTML =
                "ì´ìš© ê°€ëŠ¥: " + availableN + "íšŒ<br/>" +
                "ê¸°ë³¸ " + cN.base + " / ì¶”ê°€ " + cN.bonus;

              boxN.appendChild(ctrN);
              boxN.appendChild(infoN);

              td.appendChild(boxN);
              tr.appendChild(td);
              continue;
            }

            // ===== ì¼ì¼ë˜ì „ =====
            if (taskName === "ì¼ì¼ë˜ì „") {
              ensureCharStructures(state.activeChar);

              var boxD = document.createElement("div");
              boxD.className = "conqBox";

              var ctrD = document.createElement("div");
              ctrD.className = "conqCtr";

              var btnMinusD = document.createElement("button");
              btnMinusD.type = "button";
              btnMinusD.textContent = "-";

              var cD = state.counts[state.activeChar].dailyDungeon;

              var countSpanD = document.createElement("span");
              countSpanD.textContent = cD.used + "íšŒ";

              var btnPlusD = document.createElement("button");
              btnPlusD.type = "button";
              btnPlusD.textContent = "+";

              var availableD = getAvailableCount(cD);

              btnMinusD.disabled = cD.used <= 0;
              btnPlusD.disabled = availableD <= 0;

              btnPlusD.addEventListener("click", function(){
                adjustCount(state.activeChar, "dailyDungeon", +1);
                render();
              });

              btnMinusD.addEventListener("click", function(){
                adjustCount(state.activeChar, "dailyDungeon", -1);
                render();
              });

              ctrD.appendChild(btnMinusD);
              ctrD.appendChild(countSpanD);
              ctrD.appendChild(btnPlusD);

              var infoD = document.createElement("div");
              infoD.className = "conqInfo";
              infoD.innerHTML =
                "ì´ìš© ê°€ëŠ¥: " + availableD + "íšŒ<br/>" +
                "ê¸°ë³¸ " + cD.base + " / ì¶”ê°€ " + cD.bonus;

              boxD.appendChild(ctrD);
              boxD.appendChild(infoD);

              td.appendChild(boxD);
              tr.appendChild(td);
              continue;
            }

            // ===== í† ë²Œì „/ê°ì„±ì „ =====
            if (taskName === "í† ë²Œì „" || taskName === "ê°ì„±ì „") {
              ensureCharStructures(state.activeChar);

              var type = (taskName === "í† ë²Œì „") ? "raid" : "awakening";
              var cW = state.counts[state.activeChar][type];

              var boxW = document.createElement("div");
              boxW.className = "conqBox";

              var ctrW = document.createElement("div");
              ctrW.className = "conqCtr";

              var btnMinusW = document.createElement("button");
              btnMinusW.textContent = "-";

              var spanW = document.createElement("span");
              spanW.textContent = cW.used + "íšŒ";

              var btnPlusW = document.createElement("button");
              btnPlusW.textContent = "+";

              var availableW = getAvailableCount(cW);

              btnMinusW.disabled = cW.used <= 0;
              btnPlusW.disabled = availableW <= 0;

              (function(tt){
                btnPlusW.onclick = function(){
                  adjustCount(state.activeChar, tt, +1);
                  render();
                };
                btnMinusW.onclick = function(){
                  adjustCount(state.activeChar, tt, -1);
                  render();
                };
              })(type);

              ctrW.appendChild(btnMinusW);
              ctrW.appendChild(spanW);
              ctrW.appendChild(btnPlusW);

              var infoW = document.createElement("div");
              infoW.className = "conqInfo";
              infoW.innerHTML =
                "ì´ìš© ê°€ëŠ¥: " + availableW + "íšŒ<br/>" +
                "ê¸°ë³¸ " + cW.base + " / ì¶”ê°€ " + cW.bonus;

              boxW.appendChild(ctrW);
              boxW.appendChild(infoW);

              td.appendChild(boxW);
              tr.appendChild(td);
              continue;
            }

            // ===== íšŒë‘ =====
            if (taskName === HOERANG){
              var hbox = document.createElement("div");
              hbox.className = "hoerangBox";

              (function(dayName){
                var pi;
                for (pi = 0; pi < HOERANG_PARTS.length; pi += 1){
                  (function(partName){
                    var label = document.createElement("label");
                    label.className = "mini";
                    label.title = partName;

                    var cb = document.createElement("input");
                    cb.type = "checkbox";
                    cb.checked = getValue(state.activeChar, HOERANG, dayName, partName);

                    cb.addEventListener("change", function(){
                      setValue(state.activeChar, HOERANG, dayName, cb.checked, partName);
                      save("ì²´í¬ ë³€ê²½ (íšŒë‘-" + partName + ")");
                      render();
                    });

                    var text = document.createElement("span");
                    text.textContent = partName;

                    label.appendChild(cb);
                    label.appendChild(text);
                    hbox.appendChild(label);
                  })(HOERANG_PARTS[pi]);
                }
              })(day);

              td.appendChild(hbox);
              tr.appendChild(td);
              continue;
            }

            // ===== ì´ˆì›” =====
            if (taskName === CHO_WOL){
              ensureCharStructures(state.activeChar);

              var boxT = document.createElement("div");
              boxT.className = "conqBox";

              (function(dayName){
                ["ë°ìš°ìŠ¤","ì•„ë¥´ì¹´ë‹ˆìŠ¤"].forEach(function(part){
                  var row = document.createElement("div");
                  row.className = "conqCtr";

                  var label = document.createElement("span");
                  label.textContent = part;

                  var btnMinus = document.createElement("button");
                  btnMinus.type = "button";
                  btnMinus.textContent = "-";

                  var span = document.createElement("span");
                  span.textContent = state.transcendUsed[state.activeChar][dayName][part] + "íšŒ";

                  var btnPlus = document.createElement("button");
                  btnPlus.type = "button";
                  btnPlus.textContent = "+";

                  var btnPlus2 = document.createElement("button");
                  btnPlus2.type = "button";
                  btnPlus2.className = "btn2x";
                  btnPlus2.textContent = "2Ã—";
                  btnPlus2.title = "2íšŒ ì¶”ê°€ (ì˜¤ë“œ 80)";

                  var oddTotalNow = getOddTotal(state.activeChar);
                  btnPlus.disabled = oddTotalNow < 40;
                  btnPlus2.disabled = oddTotalNow < 80;

                  btnMinus.onclick = function(){
                    transcendDec(state.activeChar, dayName, part);
                    render();
                  };

                  btnPlus.onclick = function(){
                    transcendInc(state.activeChar, dayName, part);
                    render();
                  };

                  btnPlus2.onclick = function(){
                    transcendInc80(state.activeChar, dayName, part);
                    render();
                  };

                  row.appendChild(label);
                  row.appendChild(btnMinus);
                  row.appendChild(span);
                  row.appendChild(btnPlus);
                  row.appendChild(btnPlus2);

                  boxT.appendChild(row);
                });
              })(day);

              td.appendChild(boxT);
              tr.appendChild(td);
              continue;
            }

            // ===== ê¸°ë³¸ ì²´í¬ë°•ìŠ¤ =====
            var cb2 = document.createElement("input");
            cb2.type = "checkbox";
            cb2.checked = getValue(state.activeChar, taskName, day);

            (function(task, dayName, checkbox){
              checkbox.addEventListener("change", function(){
                setValue(state.activeChar, task, dayName, checkbox.checked);
                save("ì²´í¬ ë³€ê²½");
                render();
              });
            })(taskName, day, cb2);

            td.appendChild(cb2);
            tr.appendChild(td);
          }

          tbody.appendChild(tr);
        }

        table.appendChild(tbody);
      }

      function wireButtons(){
        function on(id, evt, fn){
          var el = document.getElementById(id);
          if (!el) return;
          el.addEventListener(evt, fn);
        }

        on("toggleViewBtn", "click", function(){ toggleViewMode(); });
        on("addCharBtn", "click", function(){ addCharacter(); });
        on("renameCharBtn", "click", function(){ renameCurrentCharacter(); });
        on("removeCharBtn", "click", function(){ removeCurrentCharacter(); });
        
        on("prevCharBtn", "click", function(){ switchCharByDelta(-1); });
        on("nextCharBtn", "click", function(){ switchCharByDelta(+1); });

        on("resetCharBtn", "click", function(){
          var ok = confirm("[" + state.activeChar + "] ë°ì´í„°ë¥¼ ì „ë¶€ ì´ˆê¸°í™”í• ê¹Œìš”?");
          if (!ok) return;
          resetChar(state.activeChar);
        });

        on("resetAllBtn", "click", function(){
          var ok = confirm("ëª¨ë“  ìºë¦­í„° ë°ì´í„°ë¥¼ ì „ë¶€ ì´ˆê¸°í™”í• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)");
          if (!ok) return;
          resetAll();
        });

        on("exportBtn", "click", function(){ exportJson(); });

        on("importBtn", "click", function(){
          var ok = confirm("ë°±ì—… JSONìœ¼ë¡œ ë®ì–´ì“¸ê¹Œìš”? í˜„ì¬ ë°ì´í„°ëŠ” êµì²´ë©ë‹ˆë‹¤.");
          if (!ok) return;
          importJson();
        });

        on("editCharBtn", "click", function(){ openEditModal(); });
        on("editModalCancel", "click", function(){ closeEditModal(); });
        on("editModalCloseX", "click", function(){ closeEditModal(); });
        on("editModalSave", "click", function(){ saveEditModal(); });

        on("oddCalibResetBtn", "click", function(){
          var char = state.activeChar;
          ensureCharStructures(char);

          var ok = confirm("[" + char + "] ì˜¤ë“œ ì¶©ì „ ë³´ì •ì„ ì´ˆê¸°í™”í• ê¹Œìš”?\n(ë‹¤ì‹œ ì‹œê°„ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤)");
          if (!ok) return;

          state.oddEnergy[char].lastBaseCharge = "";
          save("ì˜¤ë“œ ë³´ì • ì´ˆê¸°í™”");
          render();
        });

        on("shugoAlarmBtn", "click", function(){ requestShugoPermission(); });
                
        // ===== ì‚¬ì´ë“œíŒ¨ë„ "ê°’ ìˆ˜ì •" ë²„íŠ¼ë“¤ =====
        on("sideOddAddBtn", "click", function(){
          var char = state.activeChar;
          ensureCharStructures(char);

          var cur = state.oddEnergy[char].charged || 0;
          var n = askSetNumber("ì¶”ê°€ ì˜¤ë“œì—ë„ˆì§€ ìˆ˜ì •", cur, "ì¶”ê°€ ì˜¤ë“œì—ë„ˆì§€(ì¶©ì „) ê°’ì„ 'ì„¤ì •'í•©ë‹ˆë‹¤.");
          if (n === null) return;

          setBonusOdd(char, n);
        });

        // ì •ë³µ/ì´ˆì›”ë„ bonus odd(=charged) ìˆ˜ì •ìœ¼ë¡œ í†µì¼
        on("sideConqAddBtn", "click", function(){
          var char = state.activeChar;
          ensureCharStructures(char);

          var cur = state.oddEnergy[char].charged || 0;
          var n = askSetNumber("ì¶”ê°€ ì˜¤ë“œì—ë„ˆì§€ ìˆ˜ì •(ì •ë³µ)", cur, "ì¶”ê°€ ì˜¤ë“œì—ë„ˆì§€(ì¶©ì „) ê°’ì„ 'ì„¤ì •'í•©ë‹ˆë‹¤.");
          if (n === null) return;

          setBonusOdd(char, n);
        });

        on("sideTransAddBtn", "click", function(){
          var char = state.activeChar;
          ensureCharStructures(char);

          var cur = state.oddEnergy[char].charged || 0;
          var n = askSetNumber("ì¶”ê°€ ì˜¤ë“œì—ë„ˆì§€ ìˆ˜ì •(ì´ˆì›”)", cur, "ì¶”ê°€ ì˜¤ë“œì—ë„ˆì§€(ì¶©ì „) ê°’ì„ 'ì„¤ì •'í•©ë‹ˆë‹¤.");
          if (n === null) return;

          setBonusOdd(char, n);
        });

        on("sideNmAddBtn", "click", function(){
          var char = state.activeChar;
          ensureCharStructures(char);

          var c = state.counts[char].nightmare;
          var cur = c.bonus || 0;

          var n = askSetNumber("ì•…ëª½ ì¶”ê°€ ì…ì¥ê¶Œ ìˆ˜ì •", cur, "ì¶”ê°€ ì…ì¥ê¶Œ(bonus) ê°’ì„ 'ì„¤ì •'í•©ë‹ˆë‹¤.");
          if (n === null) return;

          setBonusTicket(char, "nightmare", n, "ì•…ëª½");
        });

        on("sideDdAddBtn", "click", function(){
          var char = state.activeChar;
          ensureCharStructures(char);

          var c = state.counts[char].dailyDungeon;
          var cur = c.bonus || 0;

          var n = askSetNumber("ì¼ì¼ë˜ì „ ì¶”ê°€ ì…ì¥ê¶Œ ìˆ˜ì •", cur, "ì¶”ê°€ ì…ì¥ê¶Œ(bonus) ê°’ì„ 'ì„¤ì •'í•©ë‹ˆë‹¤.");
          if (n === null) return;

          setBonusTicket(char, "dailyDungeon", n, "ì¼ì¼ë˜ì „");
        });

        on("sideAwAddBtn", "click", function(){
          var char = state.activeChar;
          ensureCharStructures(char);

          var c = state.counts[char].awakening;
          var cur = c.bonus || 0;

          var n = askSetNumber("ê°ì„±ì „ ì¶”ê°€ ì…ì¥ê¶Œ ìˆ˜ì •", cur, "ì¶”ê°€ ì…ì¥ê¶Œ(bonus) ê°’ì„ 'ì„¤ì •'í•©ë‹ˆë‹¤.");
          if (n === null) return;

          setBonusTicket(char, "awakening", n, "ê°ì„±ì „");
        });

        on("sideRdAddBtn", "click", function(){
          var char = state.activeChar;
          ensureCharStructures(char);

          var c = state.counts[char].raid;
          var cur = c.bonus || 0;

          var n = askSetNumber("í† ë²Œì „ ì¶”ê°€ ì…ì¥ê¶Œ ìˆ˜ì •", cur, "ì¶”ê°€ ì…ì¥ê¶Œ(bonus) ê°’ì„ 'ì„¤ì •'í•©ë‹ˆë‹¤.");
          if (n === null) return;

          setBonusTicket(char, "raid", n, "í† ë²Œì „");
        });
        
        on("loginBtn", "click", function(){
          var fb = window.__fb;
          var provider = new fb.GoogleAuthProvider();
          fb.signInWithPopup(fb.auth, provider);
        });
        
        on("logoutBtn", "click", function(){
          window.__fb.signOut(window.__fb.auth);
        });



        (function(){
          var overlay = document.getElementById("editModal");
          if (!overlay) return;

          var downOnOverlay = false;

          overlay.addEventListener("pointerdown", function(ev){
            // ì˜¤ë²„ë ˆì´(ë°°ê²½)ì—ì„œ ì‹œì‘í–ˆì„ ë•Œë§Œ true
            downOnOverlay = (ev.target === overlay);
          });

          overlay.addEventListener("pointerup", function(ev){
            // ì‹œì‘ë„ ì˜¤ë²„ë ˆì´, ëë„ ì˜¤ë²„ë ˆì´ì¼ ë•Œë§Œ ë‹«ê¸°
            if (downOnOverlay && ev.target === overlay){
              closeEditModal();
            }
            downOnOverlay = false;
          });

          // ì•ˆì „ì¥ì¹˜: pointercancelì—ì„œë„ ì´ˆê¸°í™”
          overlay.addEventListener("pointercancel", function(){
            downOnOverlay = false;
          });
        })();
      }

      function calibrateBaseOddIfNeeded(char){
        ensureCharStructures(char);

        var odd = state.oddEnergy[char];

        // ì´ë¯¸ ê¸°ì¤€ ìˆìœ¼ë©´ ì•ˆ ëœ¸
        if (odd.lastBaseCharge){
          return;
        }

        // âœ… ëª¨ë‹¬ ì—´ë¦° ë™ì•ˆ 1ë²ˆë§Œ ë„ìš°ê¸° (ì·¨ì†Œ/í¬ì»¤ìŠ¤ ë°˜ë³µ ë°©ì§€)
        if (state.__oddCalibPromptedOnce){
          return;
        }
        state.__oddCalibPromptedOnce = true;

        var remainMin = prompt(
          "ê¸°ë³¸ ì˜¤ë“œì—ë„ˆì§€ ë‹¤ìŒ ì¶©ì „ê¹Œì§€ ë‚¨ì€ ì‹œê°„ì„ ë¶„ ë‹¨ìœ„ë¡œ ì…ë ¥í•˜ì„¸ìš”.\n" +
          "(ì˜ˆ: 1ì‹œê°„ 50ë¶„ â†’ 110 ì…ë ¥)\n\n" +
          "â€» ìµœì´ˆ 1íšŒë§Œ í•„ìš”í•©ë‹ˆë‹¤."
        );

        if (remainMin === null){
          return;
        }

        remainMin = parseInt(remainMin, 10);
        if (isNaN(remainMin) || remainMin <= 0){
          alert("ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
          return;
        }

        var now = Date.now();
        var interval = 3 * 60 * 60 * 1000;
        var last = now + (remainMin * 60 * 1000) - interval;

        odd.lastBaseCharge = new Date(last).toISOString();
        save("ê¸°ë³¸ ì˜¤ë“œ ê¸°ì¤€ ë³´ì •");
      }


      function bindEditTotalLive(){
        function val(id){
          var el = document.getElementById(id);
          if (!el) return 0;
          var v = parseInt(el.value, 10);
          if (isNaN(v) || v < 0) v = 0;
          return v;
        }

        function refresh(){
          var oddTotalEl = document.getElementById("editOddTotal");
          if (oddTotalEl) oddTotalEl.value = val("editOddNormal") + val("editOddCharged");

          var nmTotalEl = document.getElementById("editNightmareTotal");
          if (nmTotalEl) nmTotalEl.value = val("editNightmareBase") + val("editNightmareBonus");

          var ddTotalEl = document.getElementById("editDailyDungeonTotal");
          if (ddTotalEl) ddTotalEl.value = val("editDailyDungeonBase") + val("editDailyDungeonBonus");

          var awTotalEl = document.getElementById("editAwakeningTotal");
          if (awTotalEl) awTotalEl.value = val("editAwakeningBase") + val("editAwakeningBonus");

          var rdTotalEl = document.getElementById("editRaidTotal");
          if (rdTotalEl) rdTotalEl.value = val("editRaidBase") + val("editRaidBonus");
        }
        [
          "editOddNormal","editOddCharged",
          "editNightmareBase","editNightmareBonus",
          "editDailyDungeonBase","editDailyDungeonBonus",
          "editAwakeningBase","editAwakeningBonus",
          "editRaidBase","editRaidBonus"
        ].forEach(function(id){
          var el = document.getElementById(id);
          if (!el) return;

          // âœ… ì˜¤ë“œ ì…ë ¥ì¹¸: í¬ì»¤ìŠ¤ë§Œ ì™€ë„ ë³´ì • prompt + ì´í•© ê°±ì‹ 
          if (id === "editOddNormal" || id === "editOddCharged"){
            el.onfocus = function(){
              calibrateBaseOddIfNeeded(state.activeChar);
              refresh();
            };
            el.oninput = refresh; // ì…ë ¥ ì¤‘ ì´í•© ê°±ì‹ 
            return;
          }

          el.oninput = refresh;
        });
      }

      function bindEditTotalLiveOnce(){
        if (bindEditTotalLiveOnce._done) return;
        bindEditTotalLiveOnce._done = true;
        bindEditTotalLive();
      }

      function render(){
        runAutoCharges();
        renderTabs();
        renderHeader();
        renderGrid();
        renderSidePanel();
      }
      
      var fbUser = null;
      var FB_DOC_PATH = null;
      
      function fbSave(payload){
        if (!fbUser || !window.__fb) return;
        var fb = window.__fb;
      
        return fb.setDoc(
          fb.doc(fb.db, "users", fbUser.uid),
          {
            payload: payload,
            updatedAt: fb.serverTimestamp()
          },
          { merge: true }
        );
      }
      
      function fbLoad(){
        if (!fbUser || !window.__fb) return Promise.resolve(null);
        var fb = window.__fb;
      
        return fb.getDoc(
          fb.doc(fb.db, "users", fbUser.uid)
        ).then(function(snap){
          if (!snap.exists()) return null;
          return snap.data().payload || null;
        });
      }

      function init(){
      
        // 1) ì´ë²¤íŠ¸/ì„¤ì •/ë²„íŠ¼ ë°”ì¸ë”©ì€ 1íšŒë§Œ
        loadShugoState();
        wireButtons();
        loadShugoPrefs();
        updateShugoAlarmBtn();
      
        // (ì¤‘ìš”) íƒ€ì´ë¨¸ë„ 1íšŒë§Œ
        updateShugoPanel();
        setInterval(updateShugoPanel, 1000);
      
        // 2) ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ë°ì´í„° ë¡œë“œ + ë Œë”ëŠ” ì—¬ê¸°ì„œë§Œ!
        window.__fb.onAuthStateChanged(window.__fb.auth, function(user){
          fbUser = user;
      
          var loginBtn = document.getElementById("loginBtn");
          var logoutBtn = document.getElementById("logoutBtn");
      
          if (loginBtn && logoutBtn){
            if (user){
              loginBtn.style.display = "none";
              logoutBtn.style.display = "inline-block";
            } else {
              loginBtn.style.display = "inline-block";
              logoutBtn.style.display = "none";
            }
          }
      
          if (user){
            fbLoad().then(function(remote){
              if (remote){
                localStorage.setItem(STORAGE_KEY, JSON.stringify(remote));
              }
      
              // âœ… ì—¬ê¸°ì„œë§Œ ë¡œë“œ/ë Œë”
              load();
      
              var raw = localStorage.getItem(STORAGE_KEY);
              if (raw){
                try{
                  var parsed = JSON.parse(raw);
                  if (parsed && parsed.meta && parsed.meta.savedAt){
                    updateSavedLabel(parsed.meta.savedAt);
                  }
                } catch(e){}
              }
      
              render();
            });
          } else {
            // âœ… ë¡œê·¸ì•„ì›ƒì´ë©´ ë¡œì»¬ë§Œ ì‚¬ìš©
            load();
      
            var raw2 = localStorage.getItem(STORAGE_KEY);
            if (raw2){
              try{
                var parsed2 = JSON.parse(raw2);
                if (parsed2 && parsed2.meta && parsed2.meta.savedAt){
                  updateSavedLabel(parsed2.meta.savedAt);
                }
              } catch(e){}
            }
      
            render();
          }
        });
      }


      init();
    })();
  </script>
</body>
</html>
